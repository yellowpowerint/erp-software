# Session M0.2 - Backend & Dashboard Readiness Plan

**Date**: December 28, 2025  
**Status**: Complete ‚úÖ  
**Session Duration**: 1 day (as planned)

## Executive Summary

This document provides a comprehensive analysis of the backend API readiness for the Mining ERP mobile application. After reviewing the existing backend implementation in `dev/backend/src`, we've identified that **the backend is well-prepared for mobile MVP features** with most required endpoints already implemented. The `/api/mobile/config` endpoint exists and is functional.

## 1. API Gap Analysis by Module

### ‚úÖ Authentication & Session Management
**Status**: Ready for Mobile

**Existing Endpoints**:
- `POST /api/auth/login` - User authentication
- `GET /api/auth/me` - Session bootstrap
- JWT token-based authentication

**Mobile Requirements**: ‚úÖ Met
- Login flow supported
- Token refresh via re-authentication
- User profile retrieval

**Gaps**: None

---

### ‚úÖ Mobile Configuration
**Status**: Ready for Mobile

**Existing Endpoints**:
- `GET /api/mobile/config` - App configuration (public endpoint)
- `POST /api/mobile/devices/register` - Device registration with push tokens
- `POST /api/mobile/devices/unregister` - Device unregistration

**Implementation Details** (`dev/backend/src/modules/mobile/mobile.service.ts`):
```typescript
interface MobileConfigResponse {
  minimumVersions: { ios: string; android: string };
  storeUrls: { ios: string; android: string };
  featureFlags: {
    home: boolean;
    work: boolean;
    modules: boolean;
    notifications: boolean;
    more: boolean;
  };
  maintenance: { enabled: boolean; message: string };
  forceUpdateMessage: string | null;
  serverTime: string;
}
```

**Configuration Sources**:
1. Database: `SystemSetting` table with key `MOBILE_CONFIG_JSON`
2. Environment variables: `MOBILE_MIN_VERSION_IOS`, `MOBILE_MIN_VERSION_ANDROID`, etc.
3. Feature flags: `MOBILE_FEATURE_FLAGS` (JSON)

**Mobile Requirements**: ‚úÖ Met
- Force update mechanism
- Feature flag toggles
- Maintenance mode
- Device revocation support

**Gaps**: None

---

### ‚úÖ Approvals (Work Tab - Priority 1)
**Status**: Ready for Mobile

**Existing Endpoints**:
- `GET /api/approvals` - List approvals with filters (status, type, assignedTo)
- `GET /api/approvals/item/:type/:id` - Get approval detail
- `POST /api/approvals/item/:type/:id/approve` - Approve with comment
- `POST /api/approvals/item/:type/:id/reject` - Reject with reason
- `GET /api/approvals/stats` - Dashboard statistics

**Supported Approval Types**:
- Invoices (`/api/approvals/invoices`)
- Purchase Requests (`/api/approvals/purchase-requests`)
- IT Requests (`/api/approvals/it-requests`)
- Payment Requests (`/api/approvals/payment-requests`)

**Mobile Requirements**: ‚úÖ Met
- List view with filters
- Detail view with full context
- Approve/reject actions
- Comments and history
- Role-based access control

**Gaps**: None

---

### ‚úÖ Tasks (Work Tab - Priority 1)
**Status**: Ready for Mobile

**Existing Endpoints**:
- `GET /api/tasks` - List tasks with filters
- `GET /api/tasks/:id` - Get task detail

**Mobile Requirements**: ‚ö†Ô∏è Partially Met
- List view ‚úÖ
- Detail view ‚úÖ
- Status updates ‚ùå **Missing**
- Comments ‚ùå **Missing**

**Gaps Identified**:
1. **Missing**: `PUT /api/tasks/:id/status` - Update task status
2. **Missing**: `POST /api/tasks/:id/comments` - Add task comment
3. **Missing**: `GET /api/tasks/:id/comments` - Get task comments

**Recommendation**: Add task mutation endpoints in Phase M3 (when implementing Work tab features)

---

### ‚úÖ Notifications (Home Tab)
**Status**: Ready for Mobile

**Existing Endpoints**:
- `GET /api/notifications` - List notifications (with `?unreadOnly=true`)
- `GET /api/notifications/unread-count` - Unread count badge
- `GET /api/notifications/:id` - Notification detail
- `POST /api/notifications/:id/read` - Mark as read
- `POST /api/notifications/mark-all-read` - Mark all as read
- `POST /api/notifications/:id/delete` - Delete notification

**Mobile Requirements**: ‚úÖ Met
- Inbox list with read/unread state
- Unread count for badge
- Mark as read/unread
- Deep link routing (handled client-side via `miningerp://` scheme)

**Gaps**: None

---

### ‚ö†Ô∏è Inventory (Modules Tab - View Only in MVP)
**Status**: Mostly Ready

**Existing Endpoints**:
- `GET /api/inventory/items` - List stock items (with filters)
- `GET /api/inventory/items/:id` - Item detail
- `GET /api/inventory/movements` - Stock movements history
- `GET /api/inventory/stats` - Inventory statistics
- `GET /api/inventory/alerts/low-stock` - Low stock alerts

**Mobile Requirements**: ‚úÖ Met (View-Only)
- List view with search/filters
- Item detail with current stock
- Low stock alerts
- Movement history

**Gaps**: None for MVP (write operations not needed)

---

### ‚ö†Ô∏è Safety (Modules Tab - Offline Capture in MVP)
**Status**: Partially Ready

**Existing Endpoints**:
- `POST /api/safety/incidents` - Create incident
- `PUT /api/safety/incidents/:id/photos` - Append photos
- `GET /api/safety/incidents` - List incidents
- `GET /api/safety/incidents/:id` - Incident detail
- `GET /api/safety/inspections` - List inspections
- `GET /api/safety/trainings` - List trainings

**Mobile Requirements**: ‚úÖ Met
- Offline incident capture (POST endpoint exists)
- Photo upload support
- List and detail views

**Offline Strategy**:
- Mobile app queues incidents locally (SQLite)
- Syncs when online via `POST /api/safety/incidents`
- Photos uploaded separately via `PUT /api/safety/incidents/:id/photos`

**Gaps**: None

---

### ‚úÖ HR (Modules Tab - View Only in MVP)
**Status**: Ready for Mobile

**Existing Endpoints**:
- `GET /api/hr/employees` - List employees
- `GET /api/hr/employees/:id` - Employee detail
- `GET /api/hr/leave-requests` - List leave requests
- `GET /api/hr/leave-requests/:id` - Leave request detail
- `POST /api/hr/leave-requests` - Submit leave request
- `GET /api/hr/attendance` - Attendance records

**Mobile Requirements**: ‚úÖ Met
- View employee directory
- View leave requests
- Submit leave request

**Gaps**: None for MVP

---

### ‚úÖ Documents (Modules Tab - View Only in MVP)
**Status**: Ready for Mobile

**Existing Endpoints**:
- `GET /api/documents` - List documents with filters
- `GET /api/documents/:id` - Document detail
- `GET /api/documents/:id/download` - Download file
- `POST /api/documents/:id/extract-text` - OCR extraction

**Mobile Requirements**: ‚úÖ Met (View-Only)
- List documents
- View document metadata
- Download/view documents

**Gaps**: None for MVP (upload not required)

---

## 2. Mobile Configuration Endpoint Contract

### Endpoint: `GET /api/mobile/config`

**Status**: ‚úÖ Already Implemented

**Access**: Public (no authentication required)

**Response Schema**:
```json
{
  "minimumVersions": {
    "ios": "1.0.0",
    "android": "1.0.0"
  },
  "storeUrls": {
    "ios": "https://apps.apple.com/app/mining-erp/...",
    "android": "https://play.google.com/store/apps/details?id=com.yellowpowerinternational.miningerp"
  },
  "featureFlags": {
    "home": true,
    "work": true,
    "modules": true,
    "notifications": true,
    "more": true
  },
  "maintenance": {
    "enabled": false,
    "message": "We are currently performing scheduled maintenance. Please try again shortly."
  },
  "forceUpdateMessage": null,
  "serverTime": "2025-12-28T18:00:00.000Z"
}
```

**Configuration Management**:

1. **Database Configuration** (Primary):
   - Table: `SystemSetting`
   - Key: `MOBILE_CONFIG_JSON`
   - Value: JSON object with all config fields

2. **Environment Variables** (Fallback):
   - `MOBILE_MIN_VERSION_IOS`
   - `MOBILE_MIN_VERSION_ANDROID`
   - `MOBILE_APP_STORE_URL`
   - `MOBILE_PLAY_STORE_URL`
   - `MOBILE_FEATURE_FLAGS` (JSON string)

3. **Device Revocation**:
   - Table: `SystemSetting`
   - Key: `MOBILE_REVOKED_DEVICE_IDS_JSON`
   - Value: JSON array of revoked device IDs

**Dashboard Requirements** (Web Frontend):

To manage mobile app configuration, the web dashboard should provide:

1. **Mobile App Settings Page** (`/settings/mobile-app`):
   - Minimum version inputs (iOS/Android)
   - Store URL inputs
   - Feature flag toggles (Home, Work, Modules, Notifications, More)
   - Maintenance mode toggle + message editor
   - Force update message editor
   - Device management table (view registered devices, revoke access)

2. **Implementation**:
   - CRUD operations on `SystemSetting` table
   - Update `MOBILE_CONFIG_JSON` value
   - Real-time preview of config payload

**Recommendation**: Implement dashboard mobile settings page in Phase M1 or M2

---

## 3. Offline Queue Strategy

### Overview

The mobile app will use **SQLite** for local storage and implement a queue-based sync strategy for offline operations.

### 3.1 What Syncs Offline?

| Feature | Offline Support | Sync Direction | Priority |
|---------|----------------|----------------|----------|
| **Safety Incidents** | ‚úÖ Full | Upload | High |
| **Task Status Updates** | ‚úÖ Full | Upload | High |
| **Approval Actions** | ‚ùå Online Only | N/A | N/A |
| **Notifications** | ‚úÖ Read-only cache | Download | Medium |
| **Inventory Items** | ‚úÖ Read-only cache | Download | Low |
| **Documents** | ‚úÖ Read-only cache | Download | Low |

### 3.2 SQLite Schema

```sql
-- Offline Queue Table
CREATE TABLE offline_queue (
  id TEXT PRIMARY KEY,
  entity_type TEXT NOT NULL, -- 'safety_incident', 'task_update', etc.
  action TEXT NOT NULL, -- 'create', 'update', 'delete'
  payload TEXT NOT NULL, -- JSON payload
  endpoint TEXT NOT NULL, -- API endpoint to call
  method TEXT NOT NULL, -- 'POST', 'PUT', 'DELETE'
  retry_count INTEGER DEFAULT 0,
  max_retries INTEGER DEFAULT 3,
  status TEXT DEFAULT 'pending', -- 'pending', 'syncing', 'failed', 'synced'
  created_at INTEGER NOT NULL,
  synced_at INTEGER,
  error_message TEXT
);

-- Cached Data Tables
CREATE TABLE cached_notifications (
  id TEXT PRIMARY KEY,
  data TEXT NOT NULL, -- JSON
  cached_at INTEGER NOT NULL,
  expires_at INTEGER
);

CREATE TABLE cached_inventory_items (
  id TEXT PRIMARY KEY,
  data TEXT NOT NULL, -- JSON
  cached_at INTEGER NOT NULL,
  expires_at INTEGER
);

-- Safety Incident Photos (pending upload)
CREATE TABLE incident_photo_queue (
  id TEXT PRIMARY KEY,
  incident_id TEXT NOT NULL,
  local_uri TEXT NOT NULL,
  uploaded BOOLEAN DEFAULT 0,
  upload_url TEXT,
  created_at INTEGER NOT NULL
);
```

### 3.3 Sync Logic

**On App Launch**:
1. Check network connectivity
2. If online:
   - Process `offline_queue` (oldest first)
   - Refresh cached data (notifications, inventory)
   - Upload pending photos

**On Network Change** (offline ‚Üí online):
1. Trigger background sync
2. Show sync progress indicator
3. Retry failed items

**Retry Strategy**:
- Exponential backoff: 5s, 15s, 45s
- Max 3 retries per item
- After max retries, mark as `failed` and show user alert

### 3.4 Conflict Resolution

| Scenario | Resolution Strategy |
|----------|---------------------|
| **Safety Incident** | Server wins (incidents are append-only) |
| **Task Status Update** | Last-write-wins (timestamp-based) |
| **Approval Action** | Not applicable (online-only) |
| **Cached Data Stale** | Refresh from server on next sync |

**Conflict Detection**:
- Use `updatedAt` timestamps from server
- If local `updatedAt` < server `updatedAt`, discard local changes and fetch fresh data
- Show user notification if conflict detected

### 3.5 Implementation Plan

**Phase M6** (Offline + Hardening):
1. Implement SQLite database with schema above
2. Create `OfflineQueueService` to manage queue operations
3. Add network connectivity listener
4. Implement background sync worker
5. Add conflict resolution logic
6. Test offline scenarios:
   - Create incident offline ‚Üí sync online
   - Update task offline ‚Üí sync with conflict
   - Cache expiration and refresh

---

## 4. API Gaps Summary

### Critical Gaps (Block MVP)
**None** ‚úÖ

### High Priority Gaps (Needed for Phase M3 - Work Tab)
1. **Task Mutations**:
   - `PUT /api/tasks/:id/status` - Update task status
   - `POST /api/tasks/:id/comments` - Add comment
   - `GET /api/tasks/:id/comments` - List comments

**Owner**: Backend Team  
**Timeline**: Before Phase M3 (Week 3)

### Medium Priority Gaps (Nice-to-Have)
1. **Dashboard Mobile Settings Page**:
   - Web UI to manage `MOBILE_CONFIG_JSON`
   - Device management interface

**Owner**: Frontend Team  
**Timeline**: Phase M1 or M2 (Week 2-3)

### Low Priority Gaps (Future Enhancements)
1. **Push Notification Delivery**:
   - Backend service to send push notifications via FCM/APNs
   - Currently, device registration exists but no push sender

**Owner**: Backend Team  
**Timeline**: Phase M2 (Week 2)

---

## 5. Dashboard "Mobile App Settings" Requirements

### Page: `/settings/mobile-app`

**Access**: `SUPER_ADMIN`, `IT_MANAGER`

**Sections**:

#### 5.1 Version Management
- **Minimum iOS Version** (text input, semver format)
- **Minimum Android Version** (text input, semver format)
- **iOS App Store URL** (text input, URL)
- **Android Play Store URL** (text input, URL)
- **Force Update Message** (textarea, optional)

#### 5.2 Feature Flags
- **Home Tab** (toggle, default: enabled)
- **Work Tab** (toggle, default: enabled)
- **Modules Tab** (toggle, default: enabled)
- **Notifications Tab** (toggle, default: enabled)
- **More Tab** (toggle, default: enabled)

#### 5.3 Maintenance Mode
- **Maintenance Enabled** (toggle, default: disabled)
- **Maintenance Message** (textarea, shown to users when enabled)

#### 5.4 Device Management
- **Registered Devices Table**:
  - Columns: Device ID, User, Platform, App Version, Last Seen, Actions
  - Actions: View Details, Revoke Access
- **Revoked Devices List**:
  - Show revoked device IDs
  - Action: Restore Access

#### 5.5 Configuration Preview
- **Live JSON Preview** (read-only code block showing current `GET /api/mobile/config` response)
- **Test Config** button (calls API and displays result)

**API Endpoints Needed** (Frontend):
- `GET /api/settings/mobile-config` - Get current config
- `PUT /api/settings/mobile-config` - Update config
- `GET /api/mobile/devices` - List all registered devices
- `POST /api/mobile/devices/:deviceId/revoke` - Revoke device
- `POST /api/mobile/devices/:deviceId/restore` - Restore device

**Implementation Notes**:
- Store config in `SystemSetting` table with key `MOBILE_CONFIG_JSON`
- Validate semver format for version inputs
- Show warning when enabling maintenance mode
- Audit log all config changes

---

## 6. Recommendations

### Immediate Actions (Before Phase M1)
1. ‚úÖ **No blocking issues** - Backend is ready for mobile MVP
2. ‚ö†Ô∏è **Add task mutation endpoints** - Required for Phase M3 Work tab
3. üìã **Plan dashboard mobile settings page** - Nice-to-have for Phase M1/M2

### Phase-Specific Recommendations

**Phase M1** (Auth + API Client):
- Use existing `/api/auth/login` and `/api/auth/me`
- Implement JWT token storage in SecureStore
- Test token refresh flow

**Phase M2** (Dashboard + Notifications):
- Use existing `/api/notifications` endpoints
- Implement push notification registration via `/api/mobile/devices/register`
- Backend team: Implement push notification sender service

**Phase M3** (Approvals + Tasks):
- Use existing `/api/approvals` endpoints (fully ready)
- **Backend team must add task mutation endpoints before M3 starts**

**Phase M4** (Modules):
- Use existing read-only endpoints for Inventory, Safety, HR, Documents
- Implement offline safety incident capture with queue sync

**Phase M6** (Offline + Hardening):
- Implement SQLite offline queue
- Add background sync worker
- Test conflict resolution scenarios

---

## 7. Definition of Done ‚úÖ

- [x] Clear list of endpoints to build ‚Üí **3 task endpoints needed (non-blocking for MVP)**
- [x] Agreement on config payload structure ‚Üí **`GET /api/mobile/config` already implemented**
- [x] Offline rules documented ‚Üí **SQLite schema + sync strategy defined**

---

## 8. Next Steps

1. **Session M1.1** - App Skeleton + Navigation (already complete from M0.1)
2. **Session M1.2** - Auth + Secure Token Storage
3. **Backend Team** - Add task mutation endpoints before Phase M3
4. **Frontend Team** - Plan dashboard mobile settings page (optional for M1/M2)

---

## Appendix A: Backend Module Summary

| Module | Controller | Endpoints | Mobile Ready |
|--------|-----------|-----------|--------------|
| Auth | `auth.controller.ts` | 3 | ‚úÖ Yes |
| Mobile | `mobile.controller.ts` | 3 | ‚úÖ Yes |
| Approvals | `approvals.controller.ts` | 15+ | ‚úÖ Yes |
| Tasks | `tasks.controller.ts` | 2 | ‚ö†Ô∏è Partial |
| Notifications | `notifications.controller.ts` | 6 | ‚úÖ Yes |
| Inventory | `inventory.controller.ts` | 20+ | ‚úÖ Yes |
| Safety | `safety.controller.ts` | 30+ | ‚úÖ Yes |
| HR | `hr.controller.ts` | 25+ | ‚úÖ Yes |
| Documents | `documents.controller.ts` | 50+ | ‚úÖ Yes |
| Finance | `finance.controller.ts` | 10+ | ‚úÖ Yes |
| Fleet | `fleet-*.controller.ts` | 30+ | ‚úÖ Yes |
| Procurement | `procurement-*.controller.ts` | 50+ | ‚úÖ Yes |
| Projects | `projects.controller.ts` | 5+ | ‚úÖ Yes |

**Total Endpoints**: 200+  
**Mobile-Ready**: 98%  
**Gaps**: 3 task endpoints (non-blocking)

---

**Document Version**: 1.0  
**Last Updated**: December 28, 2025  
**Author**: Cascade AI (Session M0.2)  
**Status**: Complete ‚úÖ
