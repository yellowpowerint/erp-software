generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  SUPER_ADMIN
  CEO
  CFO
  DEPARTMENT_HEAD
  ACCOUNTANT
  PROCUREMENT_OFFICER
  OPERATIONS_MANAGER
  IT_MANAGER
  HR_MANAGER
  SAFETY_OFFICER
  WAREHOUSE_MANAGER
  EMPLOYEE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalType {
  INVOICE
  PURCHASE_REQUEST
  EXPENSE_CLAIM
  LEAVE_REQUEST
  PAYMENT
  IT_REQUEST
  PAYMENT_REQUEST
}

enum NotificationType {
  APPROVAL_REQUEST
  APPROVAL_APPROVED
  APPROVAL_REJECTED
  SYSTEM_ALERT
  MENTION
}

enum ITRequestType {
  EQUIPMENT
  SOFTWARE
  ACCESS
  SUPPORT
  OTHER
}

enum PaymentType {
  VOUCHER
  REIMBURSEMENT
  ADVANCE
  PETTY_CASH
}

model User {
  id        String      @id @default(uuid())
  email     String      @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole    @default(EMPLOYEE)
  status    UserStatus  @default(ACTIVE)
  department String?
  position   String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  lastLogin DateTime?

  // Relations
  createdInvoices       Invoice[]         @relation("InvoiceCreator")
  createdPurchaseRequests PurchaseRequest[] @relation("PurchaseRequestCreator")
  createdITRequests     ITRequest[]       @relation("ITRequestCreator")
  createdPaymentRequests PaymentRequest[]  @relation("PaymentRequestCreator")
  approvalActions       ApprovalHistory[] @relation("ApprovalActor")
  notifications         Notification[]    @relation("UserNotifications")
  assignedApprovals     UserAssignment[]  @relation("AssignedUser")
  approvedPayments      FinancePayment[]
  submittedExpenses     Expense[]         @relation("ExpenseSubmitter")
  approvedExpenses      Expense[]         @relation("ExpenseApprover")
  createdBudgets        Budget[]
  uploadedDocuments     Document[]        @relation("DocumentUploader")
  documentVersions      DocumentVersion[] @relation("VersionUploader")
  documentSignatures    DocumentSignature[] @relation("DocumentSigner")
  revokedSignatures     DocumentSignature[] @relation("SignatureRevoker")
  documentAccessLogs    DocumentAccessLog[] @relation("DocumentAccessor")
  createdSecurity       DocumentSecurity[]  @relation("SecurityCreator")
  ocrJobs               OCRJob[]          @relation("OCRJobCreator")
  conversionJobs        DocumentConversionJob[] @relation("ConversionJobCreator")
  createdFormTemplates  DocumentFormTemplate[] @relation("FormTemplateCreator")
  formDrafts            DocumentFormDraft[] @relation("FormDraftCreator")
  auditPackageJobs      DocumentAuditPackageJob[] @relation("AuditPackageJobCreator")
  validatedData         ExtractedDocumentData[] @relation("DataValidator")
  ocrConfigUpdates      OCRConfiguration[] @relation("OCRConfigUpdater")

  documentComments      DocumentComment[]  @relation("CommentAuthor")
  resolvedDocumentComments DocumentComment[] @relation("CommentResolver")
  documentAnnotations   DocumentAnnotation[] @relation("AnnotationAuthor")
  documentSharesCreated DocumentShare[]    @relation("ShareAuthor")
  documentSharesReceived DocumentShare[]   @relation("ShareRecipient")
  documentPresence      DocumentPresence[]

  documentUserPermissions DocumentUserPermission[] @relation("DocumentUserAccess")
  grantedDocumentUserPermissions DocumentUserPermission[] @relation("PermissionGranter")
  categoryPermissionsSet DocumentCategoryPermission[] @relation("CategoryPermissionSetter")
  permissionTemplatesCreated DocumentPermissionTemplate[] @relation("TemplateCreator")
  permissionLogsPerformed DocumentPermissionLog[] @relation("PermissionChanger")
  permissionLogsTarget DocumentPermissionLog[] @relation("PermissionTarget")

  @@map("users")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  module      String
  action      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid())
  role         UserRole
  permissionId String
  createdAt    DateTime @default(now())

  @@unique([role, permissionId])
  @@map("role_permissions")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  module    String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Invoice {
  id              String         @id @default(uuid())
  invoiceNumber   String         @unique
  supplierName    String
  supplierEmail   String?
  description     String
  amount          Float
  currency        String         @default("GHS")
  dueDate         DateTime
  status          ApprovalStatus @default(PENDING)
  createdById     String
  createdBy       User           @relation("InvoiceCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  attachmentUrl   String?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("invoices")
}

model PurchaseRequest {
  id              String         @id @default(uuid())
  requestNumber   String         @unique
  title           String
  description     String
  category        String
  quantity        Int
  estimatedCost   Float
  currency        String         @default("GHS")
  justification   String
  urgency         String         @default("NORMAL")
  status          ApprovalStatus @default(PENDING)
  createdById     String
  createdBy       User           @relation("PurchaseRequestCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  attachmentUrl   String?
  supplierSuggestion String?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("purchase_requests")
}

model ApprovalHistory {
  id              String         @id @default(uuid())
  type            ApprovalType
  referenceId     String
  approverLevel   Int            @default(1)
  approverId      String
  approver        User           @relation("ApprovalActor", fields: [approverId], references: [id])
  action          ApprovalStatus
  comments        String?
  createdAt       DateTime       @default(now())

  // Relations to specific types
  invoice         Invoice?       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId       String?
  purchaseRequest PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)
  purchaseRequestId String?

  // Relations for new types
  itRequest       ITRequest?     @relation(fields: [itRequestId], references: [id], onDelete: Cascade)
  itRequestId     String?
  paymentRequest  PaymentRequest? @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  paymentRequestId String?

  @@index([referenceId])
  @@index([approverId])
  @@index([createdAt])
  @@map("approval_history")
}

model ITRequest {
  id              String         @id @default(uuid())
  requestNumber   String         @unique
  requestType     ITRequestType
  title           String
  description     String
  priority        String         @default("NORMAL")
  status          ApprovalStatus @default(PENDING)
  createdById     String
  createdBy       User           @relation("ITRequestCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  estimatedCost   Float?
  currency        String         @default("GHS")
  justification   String
  attachmentUrl   String?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("it_requests")
}

model PaymentRequest {
  id              String         @id @default(uuid())
  requestNumber   String         @unique
  paymentType     PaymentType
  payeeName       String
  payeeAccount    String?
  description     String
  amount          Float
  currency        String         @default("GHS")
  status          ApprovalStatus @default(PENDING)
  createdById     String
  createdBy       User           @relation("PaymentRequestCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  attachmentUrl   String?
  notes           String?
  dueDate         DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("payment_requests")
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String
  referenceId String?
  referenceType String?
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model UserAssignment {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation("AssignedUser", fields: [userId], references: [id], onDelete: Cascade)
  itemType    String
  itemId      String
  assignedAt  DateTime @default(now())

  @@unique([userId, itemType, itemId])
  @@index([userId])
  @@index([itemId])
  @@map("user_assignments")
}

// Workflow System
model ApprovalWorkflow {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        ApprovalType
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stages      ApprovalStage[]
  instances   WorkflowInstance[]

  @@index([type])
  @@index([isActive])
  @@map("approval_workflows")
}

model ApprovalStage {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stageOrder  Int
  stageName   String
  approverRoles String[]
  requiresAll Boolean  @default(false)
  createdAt   DateTime @default(now())

  stageActions StageAction[]

  @@unique([workflowId, stageOrder])
  @@index([workflowId])
  @@map("approval_stages")
}

model WorkflowInstance {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    ApprovalWorkflow @relation(fields: [workflowId], references: [id])
  itemType    String
  itemId      String
  currentStage Int     @default(1)
  status      ApprovalStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stageActions StageAction[]

  @@unique([itemType, itemId])
  @@index([workflowId])
  @@index([itemId])
  @@map("workflow_instances")
}

model StageAction {
  id          String   @id @default(uuid())
  instanceId  String
  instance    WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  stageId     String
  stage       ApprovalStage @relation(fields: [stageId], references: [id])
  approverId  String
  action      ApprovalStatus
  comments    String?
  createdAt   DateTime @default(now())

  @@index([instanceId])
  @@index([stageId])
  @@map("stage_actions")
}

// Inventory & Asset Management System
enum StockUnit {
  PIECES
  KILOGRAMS
  LITERS
  METERS
  BOXES
  PALLETS
  TONS
  GALLONS
  UNITS
}

enum StockCategory {
  CONSUMABLES
  EQUIPMENT
  SPARE_PARTS
  TOOLS
  FUEL
  CHEMICALS
  SAFETY_GEAR
  OFFICE_SUPPLIES
  OTHER
}

enum MovementType {
  STOCK_IN
  STOCK_OUT
  ADJUSTMENT
  TRANSFER
  RETURN
  DAMAGED
  EXPIRED
}

model Warehouse {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  location    String
  description String?
  isActive    Boolean  @default(true)
  managerId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stockItems  StockItem[]
  movements   StockMovement[]

  @@index([isActive])
  @@map("warehouses")
}

model StockItem {
  id              String        @id @default(uuid())
  itemCode        String        @unique
  name            String
  description     String?
  category        StockCategory
  unit            StockUnit
  unitPrice       Float?
  reorderLevel    Int           @default(0)
  maxStockLevel   Int?
  warehouseId     String
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id])
  currentQuantity Int           @default(0)
  barcode         String?
  supplier        String?
  expiryDate      DateTime?
  lastRestockDate DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  movements       StockMovement[]

  @@index([category])
  @@index([warehouseId])
  @@index([currentQuantity])
  @@index([expiryDate])
  @@map("stock_items")
}

model StockMovement {
  id              String       @id @default(uuid())
  itemId          String
  item            StockItem    @relation(fields: [itemId], references: [id])
  warehouseId     String
  warehouse       Warehouse    @relation(fields: [warehouseId], references: [id])
  movementType    MovementType
  quantity        Int
  previousQty     Int
  newQty          Int
  unitPrice       Float?
  totalValue      Float?
  reference       String?
  notes           String?
  performedById   String
  createdAt       DateTime     @default(now())

  @@index([itemId])
  @@index([warehouseId])
  @@index([movementType])
  @@index([createdAt])
  @@map("stock_movements")
}

// Asset Management System
enum AssetCategory {
  HEAVY_EQUIPMENT
  VEHICLES
  MACHINERY
  TOOLS
  COMPUTERS
  FURNITURE
  OTHER
}

enum AssetStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
  RETIRED
  DAMAGED
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  CRITICAL
}

model Asset {
  id                String         @id @default(uuid())
  assetCode         String         @unique
  name              String
  description       String?
  category          AssetCategory
  manufacturer      String?
  model             String?
  serialNumber      String?
  purchaseDate      DateTime
  purchasePrice     Float
  currentValue      Float?
  depreciationRate  Float?
  location          String?
  status            AssetStatus    @default(ACTIVE)
  condition         AssetCondition @default(GOOD)
  assignedTo        String?
  notes             String?
  warrantyExpiry    DateTime?
  lastMaintenanceAt DateTime?
  nextMaintenanceAt DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  maintenanceLogs   MaintenanceLog[]

  @@index([category])
  @@index([status])
  @@index([condition])
  @@map("assets")
}

model MaintenanceLog {
  id              String   @id @default(uuid())
  assetId         String
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  maintenanceType String
  description     String
  performedBy     String?
  performedAt     DateTime
  cost            Float?
  nextDueDate     DateTime?
  notes           String?
  createdAt       DateTime @default(now())

  @@index([assetId])
  @@index([performedAt])
  @@map("maintenance_logs")
}

// Operations & Project Management System
enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

model Project {
  id              String          @id @default(uuid())
  projectCode     String          @unique
  name            String
  description     String?
  status          ProjectStatus   @default(PLANNING)
  priority        ProjectPriority @default(MEDIUM)
  location        String?
  startDate       DateTime
  endDate         DateTime?
  estimatedBudget Float?
  actualCost      Float           @default(0)
  progress        Int             @default(0)
  managerId       String?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  milestones      Milestone[]
  tasks           Task[]
  productionLogs  ProductionLog[]
  fieldReports    FieldReport[]
  payments        FinancePayment[]
  expenses        Expense[]
  budgets         Budget[]

  @@index([status])
  @@index([priority])
  @@index([startDate])
  @@map("projects")
}

model Milestone {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String
  description String?
  dueDate     DateTime
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([projectId])
  @@index([dueDate])
  @@map("milestones")
}

model Task {
  id          String     @id @default(uuid())
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String?
  status      TaskStatus @default(PENDING)
  assignedTo  String?
  dueDate     DateTime?
  isCompleted Boolean    @default(false)
  completedAt DateTime?
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([assignedTo])
  @@map("tasks")
}

// Production & Field Operations System
enum ShiftType {
  DAY
  NIGHT
  MORNING
  AFTERNOON
  EVENING
}

enum ProductionActivityType {
  MINING
  DRILLING
  BLASTING
  HAULING
  CRUSHING
  PROCESSING
  MAINTENANCE
  OTHER
}

model ProductionLog {
  id              String                 @id @default(uuid())
  projectId       String?
  project         Project?               @relation(fields: [projectId], references: [id])
  date            DateTime
  shiftType       ShiftType
  activityType    ProductionActivityType
  location        String?
  quantity        Float
  unit            String
  equipmentUsed   String?
  operatorName    String?
  notes           String?
  createdById     String
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  @@index([projectId])
  @@index([date])
  @@index([shiftType])
  @@map("production_logs")
}

model Shift {
  id          String    @id @default(uuid())
  date        DateTime
  shiftType   ShiftType
  startTime   String
  endTime     String
  supervisor  String?
  crew        String[]
  location    String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([date])
  @@index([shiftType])
  @@map("shifts")
}

model FieldReport {
  id          String   @id @default(uuid())
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  reportDate  DateTime
  location    String
  reportedBy  String
  title       String
  description String
  findings    String?
  recommendations String?
  priority    String   @default("MEDIUM")
  attachments String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([reportDate])
  @@map("field_reports")
}

// Finance & Procurement Models

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CHEQUE
  CASH
  MOBILE_MONEY
  CREDIT_CARD
  WIRE_TRANSFER
}

enum ExpenseCategory {
  OPERATIONS
  MAINTENANCE
  SALARIES
  SUPPLIES
  UTILITIES
  FUEL
  EQUIPMENT
  TRAVEL
  PROFESSIONAL_SERVICES
  TRAINING
  INSURANCE
  OTHER
}

enum BudgetPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

model FinancePayment {
  id              String        @id @default(uuid())
  paymentNumber   String        @unique
  supplierId      String?
  supplier        Supplier?     @relation(fields: [supplierId], references: [id])
  projectId       String?
  project         Project?      @relation(fields: [projectId], references: [id])
  amount          Float
  currency        String        @default("GHS")
  paymentMethod   PaymentMethod
  paymentDate     DateTime
  status          PaymentStatus @default(PENDING)
  reference       String?
  description     String
  category        String?
  approvedById    String?
  approvedBy      User?         @relation(fields: [approvedById], references: [id])
  notes           String?
  attachments     String[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([paymentNumber])
  @@index([supplierId])
  @@index([projectId])
  @@index([status])
  @@index([paymentDate])
  @@map("finance_payments")
}

model Expense {
  id              String          @id @default(uuid())
  expenseNumber   String          @unique
  category        ExpenseCategory
  projectId       String?
  project         Project?        @relation(fields: [projectId], references: [id])
  description     String
  amount          Float
  currency        String          @default("GHS")
  expenseDate     DateTime
  submittedById   String
  submittedBy     User            @relation("ExpenseSubmitter", fields: [submittedById], references: [id])
  approvedById    String?
  approvedBy      User?           @relation("ExpenseApprover", fields: [approvedById], references: [id])
  status          ApprovalStatus  @default(PENDING)
  receipt         String?
  notes           String?
  attachments     String[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([expenseNumber])
  @@index([category])
  @@index([projectId])
  @@index([status])
  @@index([expenseDate])
  @@map("expenses")
}

model Budget {
  id              String       @id @default(uuid())
  name            String
  description     String?
  category        ExpenseCategory
  projectId       String?
  project         Project?     @relation(fields: [projectId], references: [id])
  period          BudgetPeriod
  startDate       DateTime
  endDate         DateTime
  allocatedAmount Float
  spentAmount     Float        @default(0)
  currency        String       @default("GHS")
  createdById     String
  createdBy       User         @relation(fields: [createdById], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([category])
  @@index([projectId])
  @@index([period])
  @@index([startDate])
  @@map("budgets")
}

model Supplier {
  id              String           @id @default(uuid())
  supplierCode    String           @unique
  name            String
  contactPerson   String?
  email           String?
  phone           String?
  address         String?
  city            String?
  country         String           @default("Ghana")
  taxId           String?
  bankAccount     String?
  paymentTerms    String?
  category        String?
  rating          Int?
  isActive        Boolean          @default(true)
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  payments        FinancePayment[]

  @@index([supplierCode])
  @@index([isActive])
  @@map("suppliers")
}

// Knowledge Base & Documents
enum DocumentType {
  MANUAL
  SOP
  POLICY
  PROCEDURE
  REGULATION
  TRAINING
  REPORT
  OTHER
}

enum DocumentStatus {
  ACTIVE
  ARCHIVED
  DRAFT
}

model KnowledgeDocument {
  id          String         @id @default(uuid())
  title       String
  description String?
  type        DocumentType
  status      DocumentStatus @default(ACTIVE)
  content     String         @db.Text
  fileUrl     String?
  fileName    String?
  fileSize    Int?
  category    String?
  tags        String[]
  version     String?
  uploadedBy  String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([type])
  @@index([status])
  @@index([category])
  @@map("knowledge_documents")
}

// Safety & Incident Management
enum IncidentSeverity {
  MINOR
  MODERATE
  SERIOUS
  CRITICAL
  FATAL
}

enum IncidentType {
  INJURY
  NEAR_MISS
  EQUIPMENT_DAMAGE
  ENVIRONMENTAL
  SECURITY
  FIRE
  CHEMICAL_SPILL
  OTHER
}

enum IncidentStatus {
  REPORTED
  INVESTIGATING
  RESOLVED
  CLOSED
}

model SafetyIncident {
  id              String           @id @default(uuid())
  incidentNumber  String           @unique
  type            IncidentType
  severity        IncidentSeverity
  status          IncidentStatus   @default(REPORTED)
  location        String
  incidentDate    DateTime
  reportedBy      String
  reportedAt      DateTime         @default(now())
  description     String           @db.Text
  injuries        String?          @db.Text
  witnesses       String[]
  photoUrls       String[]
  aiAnalysis      String?          @db.Text
  rootCause       String?          @db.Text
  correctiveActions String?        @db.Text
  oshaReportable  Boolean          @default(false)
  oshaReport      String?          @db.Text
  investigatedBy  String?
  investigatedAt  DateTime?
  resolvedAt      DateTime?
  notes           String?          @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([incidentDate])
  @@map("safety_incidents")
}

// HR & Personnel Management
enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  TERMINATED
  RETIRED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERN
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  ON_LEAVE
}

enum LeaveType {
  ANNUAL
  SICK
  PERSONAL
  MATERNITY
  PATERNITY
  UNPAID
  EMERGENCY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ReviewRating {
  OUTSTANDING
  EXCEEDS_EXPECTATIONS
  MEETS_EXPECTATIONS
  NEEDS_IMPROVEMENT
  UNSATISFACTORY
}

model Employee {
  id              String           @id @default(uuid())
  employeeId      String           @unique
  firstName       String
  lastName        String
  email           String           @unique
  phone           String?
  dateOfBirth     DateTime?
  gender          String?
  address         String?
  city            String?
  country         String           @default("Ghana")
  
  // Employment Details
  department      String
  position        String
  employmentType  EmploymentType   @default(FULL_TIME)
  status          EmploymentStatus @default(ACTIVE)
  hireDate        DateTime
  terminationDate DateTime?
  salary          Float?
  supervisorId    String?
  
  // Emergency Contact
  emergencyContact String?
  emergencyPhone   String?
  
  // Documents & Notes
  documents       String[]
  notes           String?          @db.Text
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  attendances     Attendance[]
  leaveRequests   LeaveRequest[]
  performanceReviews PerformanceReview[]

  @@index([employeeId])
  @@index([department])
  @@index([status])
  @@map("employees")
}

model Attendance {
  id          String           @id @default(uuid())
  employeeId  String
  employee    Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date        DateTime
  status      AttendanceStatus
  checkIn     DateTime?
  checkOut    DateTime?
  workHours   Float?
  notes       String?
  markedBy    String?
  createdAt   DateTime         @default(now())

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@map("attendances")
}

model LeaveRequest {
  id            String      @id @default(uuid())
  employeeId    String
  employee      Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType     LeaveType
  startDate     DateTime
  endDate       DateTime
  totalDays     Int
  reason        String      @db.Text
  status        LeaveStatus @default(PENDING)
  approvedById  String?
  approvedAt    DateTime?
  rejectionReason String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@map("leave_requests")
}

model PerformanceReview {
  id            String       @id @default(uuid())
  employeeId    String
  employee      Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  reviewPeriod  String
  reviewDate    DateTime
  reviewerId    String
  reviewerName  String
  
  // Performance Metrics
  overallRating ReviewRating
  technicalSkills Float?
  communication   Float?
  teamwork        Float?
  productivity    Float?
  leadership      Float?
  
  strengths     String?      @db.Text
  areasForImprovement String? @db.Text
  goals         String?      @db.Text
  comments      String?      @db.Text
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([employeeId])
  @@index([reviewDate])
  @@map("performance_reviews")
}

// Recruitment & Talent Acquisition
enum JobStatus {
  DRAFT
  OPEN
  CLOSED
  ON_HOLD
  FILLED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERN
}

enum ApplicationStatus {
  SUBMITTED
  SCREENING
  SHORTLISTED
  INTERVIEW_SCHEDULED
  INTERVIEWED
  OFFERED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  RESCHEDULED
}

model JobPosting {
  id              String      @id @default(uuid())
  jobId           String      @unique
  title           String
  department      String
  location        String
  jobType         JobType
  status          JobStatus   @default(DRAFT)
  
  // Job Details
  description     String      @db.Text
  requirements    String      @db.Text
  responsibilities String     @db.Text
  qualifications  String      @db.Text
  
  // Compensation
  salaryMin       Float?
  salaryMax       Float?
  benefits        String?     @db.Text
  
  // Dates
  openDate        DateTime?
  closeDate       DateTime?
  
  // AI Generated
  aiGenerated     Boolean     @default(false)
  aiPrompt        String?     @db.Text
  
  postedBy        String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  applications    Application[]

  @@index([status])
  @@index([department])
  @@index([jobType])
  @@map("job_postings")
}

model Candidate {
  id              String      @id @default(uuid())
  candidateId     String      @unique
  firstName       String
  lastName        String
  email           String      @unique
  phone           String?
  
  // Resume/CV
  resumeUrl       String?
  resumeText      String?     @db.Text
  cvParsed        Boolean     @default(false)
  
  // Parsed Information
  skills          String[]
  experience      String?     @db.Text
  education       String?     @db.Text
  currentPosition String?
  currentCompany  String?
  yearsExperience Int?
  
  // AI Analysis
  aiSummary       String?     @db.Text
  aiSkillMatch    Float?
  aiExperienceMatch Float?
  aiCultureFit    Float?
  
  linkedinUrl     String?
  portfolioUrl    String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  applications    Application[]
  interviews      Interview[]

  @@index([email])
  @@map("candidates")
}

model Application {
  id              String            @id @default(uuid())
  jobPostingId    String
  jobPosting      JobPosting        @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  candidateId     String
  candidate       Candidate         @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  status          ApplicationStatus @default(SUBMITTED)
  coverLetter     String?           @db.Text
  
  // AI Screening
  aiScreened      Boolean           @default(false)
  aiScore         Float?
  aiRecommendation String?          @db.Text
  aiStrengths     String[]
  aiWeaknesses    String[]
  
  // Ranking
  overallScore    Float?
  rank            Int?
  
  // Dates
  appliedAt       DateTime          @default(now())
  screenedAt      DateTime?
  reviewedBy      String?
  reviewedAt      DateTime?
  
  notes           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  interviews      Interview[]

  @@unique([jobPostingId, candidateId])
  @@index([jobPostingId])
  @@index([candidateId])
  @@index([status])
  @@map("applications")
}

model Interview {
  id              String          @id @default(uuid())
  applicationId   String
  application     Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  candidateId     String
  candidate       Candidate       @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  interviewType   String
  scheduledDate   DateTime
  duration        Int
  location        String?
  meetingLink     String?
  
  interviewers    String[]
  status          InterviewStatus @default(SCHEDULED)
  
  // Interview Results
  completed       Boolean         @default(false)
  feedback        String?         @db.Text
  rating          Float?
  
  // AI Summary
  aiSummary       String?         @db.Text
  aiKeyPoints     String[]
  aiRecommendation String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([applicationId])
  @@index([candidateId])
  @@index([scheduledDate])
  @@map("interviews")
}

// Safety & Compliance Module
enum InspectionType {
  EQUIPMENT
  VEHICLE
  FACILITY
  WORKPLACE
  FIRE_SAFETY
  ELECTRICAL
  CONFINED_SPACE
  CHEMICAL_STORAGE
}

enum InspectionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
  PASSED
}

enum TrainingType {
  SAFETY_ORIENTATION
  EQUIPMENT_OPERATION
  EMERGENCY_RESPONSE
  FIRST_AID
  FIRE_SAFETY
  CONFINED_SPACE
  HAZARDOUS_MATERIALS
  PPE_USAGE
  INCIDENT_REPORTING
}

enum TrainingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum CertificationStatus {
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  SUSPENDED
  REVOKED
}

enum DrillType {
  FIRE_EVACUATION
  EMERGENCY_EVACUATION
  SPILL_RESPONSE
  RESCUE_OPERATION
  MEDICAL_EMERGENCY
}

model SafetyInspection {
  id              String           @id @default(uuid())
  inspectionId    String           @unique
  type            InspectionType
  status          InspectionStatus @default(SCHEDULED)
  
  // What is being inspected
  title           String
  location        String
  equipmentId     String?
  assetId         String?
  
  // Inspection details
  scheduledDate   DateTime
  completedDate   DateTime?
  inspectedBy     String?
  inspectorName   String?
  
  // Results
  passed          Boolean?
  score           Float?
  findings        String?          @db.Text
  deficiencies    String[]
  recommendations String?          @db.Text
  actionRequired  Boolean          @default(false)
  
  // Corrective actions
  correctiveActions String?        @db.Text
  dueDate         DateTime?
  resolvedDate    DateTime?
  resolvedBy      String?
  
  // Documentation
  checklistItems  String[]
  photoUrls       String[]
  documentUrls    String[]
  notes           String?          @db.Text
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([type])
  @@index([status])
  @@index([scheduledDate])
  @@map("safety_inspections")
}

model SafetyTraining {
  id              String         @id @default(uuid())
  trainingId      String         @unique
  type            TrainingType
  status          TrainingStatus @default(SCHEDULED)
  
  // Training details
  title           String
  description     String?        @db.Text
  location        String?
  duration        Int
  maxParticipants Int?
  
  // Scheduling
  scheduledDate   DateTime
  startTime       String?
  endTime         String?
  
  // Instructor
  instructorId    String?
  instructorName  String
  
  // Participants
  participants    String[]
  completedBy     String[]
  attendanceCount Int?
  
  // Results
  passingScore    Float?
  completed       Boolean        @default(false)
  completedDate   DateTime?
  
  // Content
  topics          String[]
  materials       String[]
  certificateUrl  String?
  
  notes           String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([type])
  @@index([status])
  @@index([scheduledDate])
  @@map("safety_trainings")
}

model SafetyCertification {
  id              String              @id @default(uuid())
  certificationId String              @unique
  
  // Employee
  employeeId      String
  employeeName    String
  
  // Certification details
  certType        String
  certName        String
  certNumber      String?
  issuingBody     String
  
  // Dates
  issueDate       DateTime
  expiryDate      DateTime
  renewalDate     DateTime?
  
  status          CertificationStatus @default(ACTIVE)
  
  // Verification
  verifiedBy      String?
  verifiedDate    DateTime?
  
  // Documentation
  certificateUrl  String?
  documentUrls    String[]
  
  notes           String?             @db.Text
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([expiryDate])
  @@map("safety_certifications")
}

model SafetyDrill {
  id              String     @id @default(uuid())
  drillId         String     @unique
  type            DrillType
  
  // Drill details
  title           String
  description     String?    @db.Text
  location        String
  
  // Scheduling
  scheduledDate   DateTime
  startTime       String?
  endTime         String?
  duration        Int?
  
  // Participants
  expectedCount   Int?
  actualCount     Int?
  participants    String[]
  
  // Coordination
  coordinator     String
  coordinatorName String
  observers       String[]
  
  // Results
  completed       Boolean    @default(false)
  completedDate   DateTime?
  successRating   Float?
  
  // Evaluation
  objectives      String[]
  results         String?    @db.Text
  strengths       String[]
  areasForImprovement String[]
  lessonsLearned  String?    @db.Text
  
  // Follow-up
  followUpActions String?    @db.Text
  actionRequired  Boolean    @default(false)
  
  notes           String?    @db.Text
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([type])
  @@index([scheduledDate])
  @@map("safety_drills")
}

// System Settings & Integrations
model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  isSecret  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// Document Management System (Phase 15.1)
enum DocumentCategory {
  INVOICE
  RECEIPT
  PURCHASE_ORDER
  QUOTATION
  CONTRACT
  SAFETY_REPORT
  INCIDENT_REPORT
  COMPLIANCE_DOC
  PROJECT_REPORT
  HR_DOCUMENT
  PAYROLL
  TAX_FORM
  AUDIT_DOCUMENT
  TRAINING_MATERIAL
  CERTIFICATE
  EQUIPMENT_MANUAL
  OTHER
}

model Document {
  id          String   @id @default(uuid())
  fileName    String
  originalName String
  fileSize    Int
  mimeType    String
  fileUrl     String
  fileHash    String?
  category    DocumentCategory
  module      String
  referenceId String?
  description String?
  tags        String[]
  version     Int      @default(1)
  isLatest    Boolean  @default(true)
  uploadedById String
  uploadedBy  User     @relation("DocumentUploader", fields: [uploadedById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  versions    DocumentVersion[]
  metadata    DocumentMetadata?
  permissions DocumentPermission[]
  userPermissions DocumentUserPermission[]
  departmentPermissions DocumentDepartmentPermission[]
  permissionLogs DocumentPermissionLog[]
  signatures  DocumentSignature[] @relation("DocumentSignatures")
  security    DocumentSecurity?   @relation("DocumentSecurity")

  comments    DocumentComment[]
  annotations DocumentAnnotation[]
  shares      DocumentShare[]
  presence    DocumentPresence[]
  aiInsight   DocumentAiInsight?
  conversionJobs DocumentConversionJob[]
  formTemplates DocumentFormTemplate[]
  formDrafts    DocumentFormDraft[]
  auditPackageOutputJobs DocumentAuditPackageJob[] @relation("AuditPackageOutputDocument")
  
  @@index([module, referenceId])
  @@index([category])
  @@index([uploadedById])
  @@index([fileHash])
  @@map("documents")
}

// Phase 16.4: AI-Powered Document Intelligence
model DocumentAiInsight {
  id               String            @id @default(uuid())
  documentId        String            @unique
  document          Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)

  provider          String?
  model             String?

  summary           String?           @db.Text
  entities          Json?
  suggestedCategory DocumentCategory?
  suggestedTags     String[]          @default([])
  anomalies         Json?
  linkedRecords     Json?

  // Optional embeddings used for semantic search and similarity
  embedding         Float[]           @default([])

  analyzedAt        DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([analyzedAt])
  @@map("document_ai_insights")
}

model DocumentVersion {
  id          String   @id @default(uuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  versionNumber Int
  fileName    String
  fileUrl     String
  fileSize    Int
  uploadedById String
  uploadedBy  User     @relation("VersionUploader", fields: [uploadedById], references: [id])
  changeNotes String?
  createdAt   DateTime @default(now())
  
  @@unique([documentId, versionNumber])
  @@map("document_versions")
}

model DocumentMetadata {
  id          String   @id @default(uuid())
  documentId  String   @unique
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  pageCount   Int?
  author      String?
  title       String?
  subject     String?
  keywords    String[]  @default([])
  createdDate DateTime?
  modifiedDate DateTime?
  extractedText String?  @db.Text
  
  @@map("document_metadata")
}

model DocumentPermission {
  id          String   @id @default(uuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  role        UserRole
  canView     Boolean  @default(false)
  canEdit     Boolean  @default(false)
  canDelete   Boolean  @default(false)
  canShare    Boolean  @default(false)
  canSign     Boolean  @default(false)
  
  @@unique([documentId, role])
  @@map("document_permissions")
}

model DocumentUserPermission {
  id          String   @id @default(uuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("DocumentUserAccess", fields: [userId], references: [id], onDelete: Cascade)
  canView     Boolean  @default(true)
  canEdit     Boolean  @default(false)
  canDelete   Boolean  @default(false)
  canShare    Boolean  @default(false)
  canSign     Boolean  @default(false)
  grantedById String
  grantedBy   User     @relation("PermissionGranter", fields: [grantedById], references: [id])
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([documentId, userId])
  @@index([userId])
  @@map("document_user_permissions")
}

model DocumentDepartmentPermission {
  id          String   @id @default(uuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  department  String
  canView     Boolean  @default(true)
  canEdit     Boolean  @default(false)
  canDelete   Boolean  @default(false)
  canShare    Boolean  @default(false)
  canSign     Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@unique([documentId, department])
  @@map("document_department_permissions")
}

model DocumentCategoryPermission {
  id          String   @id @default(uuid())
  category    DocumentCategory
  role        UserRole
  canView     Boolean  @default(false)
  canEdit     Boolean  @default(false)
  canDelete   Boolean  @default(false)
  canShare    Boolean  @default(false)
  canSign     Boolean  @default(false)
  canUpload   Boolean  @default(false)
  setById     String
  setBy       User     @relation("CategoryPermissionSetter", fields: [setById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([category, role])
  @@map("document_category_permissions")
}

model DocumentPermissionTemplate {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  category    DocumentCategory?
  module      String?
  roles       Json
  departments Json?
  isDefault   Boolean  @default(false)
  createdById String
  createdBy   User     @relation("TemplateCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("document_permission_templates")
}

enum PermissionAction {
  GRANT
  REVOKE
  MODIFY
  TEMPLATE_APPLIED
  BULK_UPDATE
}

model DocumentPermissionLog {
  id               String           @id @default(uuid())
  documentId       String?
  document         Document?        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  category         DocumentCategory?
  action           PermissionAction
  performedById    String
  performedBy      User             @relation("PermissionChanger", fields: [performedById], references: [id])
  targetUserId     String?
  targetUser       User?            @relation("PermissionTarget", fields: [targetUserId], references: [id])
  targetRole       UserRole?
  targetDepartment String?
  oldPermissions   Json?
  newPermissions   Json
  reason           String?
  ipAddress        String
  createdAt        DateTime         @default(now())

  @@index([documentId])
  @@index([performedById])
  @@index([createdAt])
  @@map("document_permission_logs")
}

// Phase 15.4: Digital Signatures & Document Security
enum SignatureType {
  DRAWN        // Hand-drawn signature
  TYPED        // Typed name
  UPLOADED     // Uploaded signature image
  CERTIFICATE  // Digital certificate (future)
}

enum DocumentAction {
  VIEWED
  DOWNLOADED
  EDITED
  DELETED
  SHARED
  SIGNED
  PERMISSION_CHANGED
  SECURITY_UPDATED
}

model DocumentSignature {
  id              String        @id @default(uuid())
  documentId      String
  document        Document      @relation("DocumentSignatures", fields: [documentId], references: [id], onDelete: Cascade)
  signerId        String
  signer          User          @relation("DocumentSigner", fields: [signerId], references: [id])
  signatureData   String        @db.Text // Base64 encoded signature image
  signatureType   SignatureType @default(DRAWN)
  signatureHash   String        // Hash of signature for verification
  ipAddress       String
  userAgent       String
  location        String?       // GPS coordinates if available
  reason          String?       // Reason for signing (e.g., "Approved invoice")
  metadata        Json?         // Additional metadata (device info, etc.)
  isValid         Boolean       @default(true)
  revokedAt       DateTime?
  revokedById     String?
  revokedBy       User?         @relation("SignatureRevoker", fields: [revokedById], references: [id])
  revokeReason    String?
  signedAt        DateTime      @default(now())
  
  @@index([documentId])
  @@index([signerId])
  @@index([signedAt])
  @@map("document_signatures")
}

model DocumentAccessLog {
  id          String         @id @default(uuid())
  documentId  String
  userId      String
  user        User           @relation("DocumentAccessor", fields: [userId], references: [id])
  action      DocumentAction
  ipAddress   String
  userAgent   String
  metadata    Json?          // Additional context (e.g., download format, edit details)
  accessedAt  DateTime       @default(now())
  
  @@index([documentId])
  @@index([userId])
  @@index([accessedAt])
  @@map("document_access_logs")
}

model DocumentSecurity {
  id                String    @id @default(uuid())
  documentId        String    @unique
  document          Document  @relation("DocumentSecurity", fields: [documentId], references: [id], onDelete: Cascade)
  isPasswordProtected Boolean @default(false)
  passwordHash      String?   // Hashed password for PDF protection
  hasWatermark      Boolean   @default(false)
  watermarkText     String?
  isEncrypted       Boolean   @default(false)
  encryptionKey     String?   // Encrypted key for sensitive documents
  expiresAt         DateTime? // Document access expiration
  maxDownloads      Int?      // Maximum number of downloads allowed
  downloadCount     Int       @default(0)
  requireSignature  Boolean   @default(false)
  allowPrint        Boolean   @default(true)
  allowCopy         Boolean   @default(true)
  createdById       String
  createdBy         User      @relation("SecurityCreator", fields: [createdById], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("document_security")
}

// Phase 16.3: Document Collaboration & Annotations
enum AnnotationType {
  HIGHLIGHT
  UNDERLINE
  STRIKETHROUGH
  NOTE
  ARROW
  RECTANGLE
  TEXT
}

model DocumentComment {
  id          String   @id @default(uuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation("CommentAuthor", fields: [authorId], references: [id])
  content     String
  pageNumber  Int?
  positionX   Float?
  positionY   Float?
  isResolved  Boolean  @default(false)
  resolvedById String?
  resolvedBy  User?    @relation("CommentResolver", fields: [resolvedById], references: [id])
  resolvedAt  DateTime?
  parentId    String?
  parent      DocumentComment? @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies     DocumentComment[] @relation("CommentThread")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([documentId])
  @@index([parentId])
  @@index([isResolved])
  @@map("document_comments")
}

model DocumentAnnotation {
  id          String   @id @default(uuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation("AnnotationAuthor", fields: [authorId], references: [id])
  type        AnnotationType
  pageNumber  Int
  coordinates Json
  content     String?
  color       String   @default("#FFFF00")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([documentId])
  @@index([pageNumber])
  @@map("document_annotations")
}

model DocumentShare {
  id          String   @id @default(uuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sharedById  String
  sharedBy    User     @relation("ShareAuthor", fields: [sharedById], references: [id])
  sharedWithId String?
  sharedWith  User?    @relation("ShareRecipient", fields: [sharedWithId], references: [id])
  shareLink   String?  @unique
  expiresAt   DateTime?
  accessCount Int      @default(0)
  canEdit     Boolean  @default(false)
  canDownload Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([documentId])
  @@index([sharedById])
  @@index([sharedWithId])
  @@map("document_shares")
}

model DocumentPresence {
  id          String   @id @default(uuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastSeenAt  DateTime @default(now())

  @@unique([documentId, userId])
  @@index([documentId])
  @@index([lastSeenAt])
  @@map("document_presence")
}

enum DocumentConversionProvider {
  LOCAL
  CLOUDCONVERT
}

enum DocumentConversionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum DocumentFormDraftStatus {
  DRAFT
  FINALIZED
  CANCELLED
}

enum DocumentAuditPackageStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model DocumentConversionJob {
  id              String                   @id @default(uuid())
  documentId      String
  document        Document                 @relation(fields: [documentId], references: [id], onDelete: Cascade)
  provider        DocumentConversionProvider @default(LOCAL)
  status          DocumentConversionStatus   @default(PENDING)
  inputMimeType   String
  outputFileUrl   String?
  outputFileName  String?
  outputFileSize  Int?
  errorMessage    String?
  startedAt       DateTime?
  completedAt     DateTime?
  processingTime  Int?
  attempts        Int                      @default(0)
  maxAttempts     Int                      @default(3)
  options         Json?
  createdById     String
  createdBy       User                     @relation("ConversionJobCreator", fields: [createdById], references: [id])
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  @@index([documentId])
  @@index([status])
  @@index([createdAt])
  @@map("document_conversion_jobs")
}

model DocumentFormTemplate {
  id             String   @id @default(uuid())
  documentId     String
  document       Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentVersion Int
  fieldSchema    Json
  fieldCount     Int      @default(0)
  createdById    String
  createdBy      User     @relation("FormTemplateCreator", fields: [createdById], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  drafts         DocumentFormDraft[]

  @@unique([documentId, documentVersion])
  @@index([documentId])
  @@index([createdAt])
  @@map("document_form_templates")
}

model DocumentFormDraft {
  id              String                 @id @default(uuid())
  documentId      String
  document        Document               @relation(fields: [documentId], references: [id], onDelete: Cascade)
  templateId      String?
  template        DocumentFormTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  status          DocumentFormDraftStatus @default(DRAFT)
  values          Json
  signatureData   String?
  signatureType   String?
  signatureReason String?
  signatureMetadata Json?
  outputFileUrl   String?
  outputFileName  String?
  outputFileSize  Int?
  outputDocumentVersion Int?
  finalizedAt     DateTime?
  cancelledAt     DateTime?
  createdById     String
  createdBy       User                   @relation("FormDraftCreator", fields: [createdById], references: [id])
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  @@index([documentId])
  @@index([templateId])
  @@index([status])
  @@index([createdAt])
  @@map("document_form_drafts")
}

model DocumentAuditPackageJob {
  id               String                   @id @default(uuid())
  status           DocumentAuditPackageStatus @default(PENDING)
  title            String
  spec             Json
  outputDocumentId String?
  outputDocument   Document?                @relation("AuditPackageOutputDocument", fields: [outputDocumentId], references: [id], onDelete: SetNull)
  errorMessage     String?
  attempts         Int                      @default(0)
  maxAttempts      Int                      @default(3)
  startedAt        DateTime?
  completedAt      DateTime?
  createdById      String
  createdBy        User                     @relation("AuditPackageJobCreator", fields: [createdById], references: [id])
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("document_audit_package_jobs")
}

// Phase 16.1: OCR & Text Extraction
enum OCRProvider {
  TESSERACT_JS
  GOOGLE_VISION
  AWS_TEXTRACT
}

enum OCRStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ExtractedDataType {
  INVOICE
  RECEIPT
  CONTRACT
  GENERAL_TEXT
  STRUCTURED_DATA
}

model OCRJob {
  id              String          @id @default(uuid())
  documentId      String
  provider        OCRProvider     @default(TESSERACT_JS)
  status          OCRStatus       @default(PENDING)
  priority        Int             @default(5) // 1-10, higher = more urgent
  
  // Processing details
  startedAt       DateTime?
  completedAt     DateTime?
  processingTime  Int?            // milliseconds
  
  // Results
  extractedText   String?         @db.Text
  confidence      Float?          // 0-100
  pageCount       Int?
  errorMessage    String?
  
  // Configuration
  language        String          @default("eng")
  autoRotate      Boolean         @default(true)
  enhanceImage    Boolean         @default(true)
  
  // Metadata
  createdById     String
  createdBy       User            @relation("OCRJobCreator", fields: [createdById], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  extractedData   ExtractedDocumentData[]
  
  @@index([documentId])
  @@index([status])
  @@index([createdAt])
  @@map("ocr_jobs")
}

model ExtractedDocumentData {
  id              String            @id @default(uuid())
  ocrJobId        String
  ocrJob          OCRJob            @relation(fields: [ocrJobId], references: [id], onDelete: Cascade)
  documentId      String
  dataType        ExtractedDataType
  
  // Extracted fields (JSON for flexibility)
  extractedFields Json              // Structured data extracted from document
  confidence      Float?            // Overall confidence score
  
  // Invoice-specific fields
  invoiceNumber   String?
  invoiceDate     DateTime?
  dueDate         DateTime?
  supplierName    String?
  supplierAddress String?
  totalAmount     Float?
  taxAmount       Float?
  currency        String?
  
  // Receipt-specific fields
  vendorName      String?
  receiptNumber   String?
  receiptDate     DateTime?
  receiptAmount   Float?
  paymentMethod   String?
  
  // Contract-specific fields
  contractNumber  String?
  contractDate    DateTime?
  partyNames      String[]
  contractValue   Float?
  startDate       DateTime?
  endDate         DateTime?
  
  // General extracted entities
  entities        Json?             // Named entities (people, organizations, dates, amounts)
  keyPhrases      String[]
  
  // Validation
  isValidated     Boolean           @default(false)
  validatedById   String?
  validatedBy     User?             @relation("DataValidator", fields: [validatedById], references: [id])
  validatedAt     DateTime?
  
  // Corrections
  correctedFields Json?             // User corrections to extracted data
  correctionNotes String?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([ocrJobId])
  @@index([documentId])
  @@index([dataType])
  @@map("extracted_document_data")
}

model OCRConfiguration {
  id                String      @id @default(uuid())
  
  // Global settings
  defaultProvider   OCRProvider @default(TESSERACT_JS)
  autoOCREnabled    Boolean     @default(false)
  autoOCRCategories DocumentCategory[]
  
  // Processing settings
  maxConcurrentJobs Int         @default(3)
  defaultLanguage   String      @default("eng")
  confidenceThreshold Float     @default(70.0)
  
  // Provider-specific settings
  tesseractConfig   Json?       // Tesseract.js configuration
  googleVisionConfig Json?      // Google Cloud Vision API config
  awsTextractConfig Json?       // AWS Textract config
  
  // Auto-processing rules
  autoCreateInvoice Boolean     @default(false)
  autoCreateExpense Boolean     @default(false)
  autoCreateContract Boolean    @default(false)
  
  // Notifications
  notifyOnCompletion Boolean    @default(true)
  notifyOnFailure   Boolean     @default(true)
  
  // Retention
  retainRawText     Boolean     @default(true)
  retainExtractedData Boolean   @default(true)
  
  updatedById       String
  updatedBy         User        @relation("OCRConfigUpdater", fields: [updatedById], references: [id])
  updatedAt         DateTime    @updatedAt
  
  @@map("ocr_configuration")
}

model OCRProcessingLog {
  id              String      @id @default(uuid())
  ocrJobId        String
  level           String      // INFO, WARNING, ERROR
  message         String      @db.Text
  metadata        Json?
  timestamp       DateTime    @default(now())
  
  @@index([ocrJobId])
  @@index([timestamp])
  @@map("ocr_processing_logs")
}
