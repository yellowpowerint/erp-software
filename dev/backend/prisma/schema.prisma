generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  CEO
  CFO
  DEPARTMENT_HEAD
  ACCOUNTANT
  PROCUREMENT_OFFICER
  OPERATIONS_MANAGER
  IT_MANAGER
  HR_MANAGER
  SAFETY_OFFICER
  WAREHOUSE_MANAGER
  EMPLOYEE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalType {
  INVOICE
  PURCHASE_REQUEST
  EXPENSE_CLAIM
  LEAVE_REQUEST
  PAYMENT
  IT_REQUEST
  PAYMENT_REQUEST
}

enum NotificationType {
  APPROVAL_REQUEST
  APPROVAL_APPROVED
  APPROVAL_REJECTED
  SYSTEM_ALERT
  MENTION
}

enum ITRequestType {
  EQUIPMENT
  SOFTWARE
  ACCESS
  SUPPORT
  OTHER
}

enum PaymentType {
  VOUCHER
  REIMBURSEMENT
  ADVANCE
  PETTY_CASH
}

model User {
  id        String      @id @default(uuid())
  email     String      @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole    @default(EMPLOYEE)
  status    UserStatus  @default(ACTIVE)
  department String?
  position   String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  lastLogin DateTime?

  // Relations
  createdInvoices       Invoice[]         @relation("InvoiceCreator")
  createdPurchaseRequests PurchaseRequest[] @relation("PurchaseRequestCreator")
  createdITRequests     ITRequest[]       @relation("ITRequestCreator")
  createdPaymentRequests PaymentRequest[]  @relation("PaymentRequestCreator")
  approvalActions       ApprovalHistory[] @relation("ApprovalActor")
  notifications         Notification[]    @relation("UserNotifications")
  assignedApprovals     UserAssignment[]  @relation("AssignedUser")
  approvedPayments      FinancePayment[]
  submittedExpenses     Expense[]         @relation("ExpenseSubmitter")
  approvedExpenses      Expense[]         @relation("ExpenseApprover")
  createdBudgets        Budget[]

  @@map("users")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  module      String
  action      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid())
  role         UserRole
  permissionId String
  createdAt    DateTime @default(now())

  @@unique([role, permissionId])
  @@map("role_permissions")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  module    String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Invoice {
  id              String         @id @default(uuid())
  invoiceNumber   String         @unique
  supplierName    String
  supplierEmail   String?
  description     String
  amount          Float
  currency        String         @default("GHS")
  dueDate         DateTime
  status          ApprovalStatus @default(PENDING)
  createdById     String
  createdBy       User           @relation("InvoiceCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  attachmentUrl   String?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("invoices")
}

model PurchaseRequest {
  id              String         @id @default(uuid())
  requestNumber   String         @unique
  title           String
  description     String
  category        String
  quantity        Int
  estimatedCost   Float
  currency        String         @default("GHS")
  justification   String
  urgency         String         @default("NORMAL")
  status          ApprovalStatus @default(PENDING)
  createdById     String
  createdBy       User           @relation("PurchaseRequestCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  attachmentUrl   String?
  supplierSuggestion String?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("purchase_requests")
}

model ApprovalHistory {
  id              String         @id @default(uuid())
  type            ApprovalType
  referenceId     String
  approverLevel   Int            @default(1)
  approverId      String
  approver        User           @relation("ApprovalActor", fields: [approverId], references: [id])
  action          ApprovalStatus
  comments        String?
  createdAt       DateTime       @default(now())

  // Relations to specific types
  invoice         Invoice?       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId       String?
  purchaseRequest PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)
  purchaseRequestId String?

  // Relations for new types
  itRequest       ITRequest?     @relation(fields: [itRequestId], references: [id], onDelete: Cascade)
  itRequestId     String?
  paymentRequest  PaymentRequest? @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  paymentRequestId String?

  @@index([referenceId])
  @@index([approverId])
  @@index([createdAt])
  @@map("approval_history")
}

model ITRequest {
  id              String         @id @default(uuid())
  requestNumber   String         @unique
  requestType     ITRequestType
  title           String
  description     String
  priority        String         @default("NORMAL")
  status          ApprovalStatus @default(PENDING)
  createdById     String
  createdBy       User           @relation("ITRequestCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  estimatedCost   Float?
  currency        String         @default("GHS")
  justification   String
  attachmentUrl   String?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("it_requests")
}

model PaymentRequest {
  id              String         @id @default(uuid())
  requestNumber   String         @unique
  paymentType     PaymentType
  payeeName       String
  payeeAccount    String?
  description     String
  amount          Float
  currency        String         @default("GHS")
  status          ApprovalStatus @default(PENDING)
  createdById     String
  createdBy       User           @relation("PaymentRequestCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  attachmentUrl   String?
  notes           String?
  dueDate         DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("payment_requests")
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String
  referenceId String?
  referenceType String?
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model UserAssignment {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation("AssignedUser", fields: [userId], references: [id], onDelete: Cascade)
  itemType    String
  itemId      String
  assignedAt  DateTime @default(now())

  @@unique([userId, itemType, itemId])
  @@index([userId])
  @@index([itemId])
  @@map("user_assignments")
}

// Workflow System
model ApprovalWorkflow {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        ApprovalType
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stages      ApprovalStage[]
  instances   WorkflowInstance[]

  @@index([type])
  @@index([isActive])
  @@map("approval_workflows")
}

model ApprovalStage {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stageOrder  Int
  stageName   String
  approverRoles String[]
  requiresAll Boolean  @default(false)
  createdAt   DateTime @default(now())

  stageActions StageAction[]

  @@unique([workflowId, stageOrder])
  @@index([workflowId])
  @@map("approval_stages")
}

model WorkflowInstance {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    ApprovalWorkflow @relation(fields: [workflowId], references: [id])
  itemType    String
  itemId      String
  currentStage Int     @default(1)
  status      ApprovalStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stageActions StageAction[]

  @@unique([itemType, itemId])
  @@index([workflowId])
  @@index([itemId])
  @@map("workflow_instances")
}

model StageAction {
  id          String   @id @default(uuid())
  instanceId  String
  instance    WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  stageId     String
  stage       ApprovalStage @relation(fields: [stageId], references: [id])
  approverId  String
  action      ApprovalStatus
  comments    String?
  createdAt   DateTime @default(now())

  @@index([instanceId])
  @@index([stageId])
  @@map("stage_actions")
}

// Inventory & Asset Management System
enum StockUnit {
  PIECES
  KILOGRAMS
  LITERS
  METERS
  BOXES
  PALLETS
  TONS
  GALLONS
  UNITS
}

enum StockCategory {
  CONSUMABLES
  EQUIPMENT
  SPARE_PARTS
  TOOLS
  FUEL
  CHEMICALS
  SAFETY_GEAR
  OFFICE_SUPPLIES
  OTHER
}

enum MovementType {
  STOCK_IN
  STOCK_OUT
  ADJUSTMENT
  TRANSFER
  RETURN
  DAMAGED
  EXPIRED
}

model Warehouse {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  location    String
  description String?
  isActive    Boolean  @default(true)
  managerId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stockItems  StockItem[]
  movements   StockMovement[]

  @@index([isActive])
  @@map("warehouses")
}

model StockItem {
  id              String        @id @default(uuid())
  itemCode        String        @unique
  name            String
  description     String?
  category        StockCategory
  unit            StockUnit
  unitPrice       Float?
  reorderLevel    Int           @default(0)
  maxStockLevel   Int?
  warehouseId     String
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id])
  currentQuantity Int           @default(0)
  barcode         String?
  supplier        String?
  expiryDate      DateTime?
  lastRestockDate DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  movements       StockMovement[]

  @@index([category])
  @@index([warehouseId])
  @@index([currentQuantity])
  @@index([expiryDate])
  @@map("stock_items")
}

model StockMovement {
  id              String       @id @default(uuid())
  itemId          String
  item            StockItem    @relation(fields: [itemId], references: [id])
  warehouseId     String
  warehouse       Warehouse    @relation(fields: [warehouseId], references: [id])
  movementType    MovementType
  quantity        Int
  previousQty     Int
  newQty          Int
  unitPrice       Float?
  totalValue      Float?
  reference       String?
  notes           String?
  performedById   String
  createdAt       DateTime     @default(now())

  @@index([itemId])
  @@index([warehouseId])
  @@index([movementType])
  @@index([createdAt])
  @@map("stock_movements")
}

// Asset Management System
enum AssetCategory {
  HEAVY_EQUIPMENT
  VEHICLES
  MACHINERY
  TOOLS
  COMPUTERS
  FURNITURE
  OTHER
}

enum AssetStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
  RETIRED
  DAMAGED
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  CRITICAL
}

model Asset {
  id                String         @id @default(uuid())
  assetCode         String         @unique
  name              String
  description       String?
  category          AssetCategory
  manufacturer      String?
  model             String?
  serialNumber      String?
  purchaseDate      DateTime
  purchasePrice     Float
  currentValue      Float?
  depreciationRate  Float?
  location          String?
  status            AssetStatus    @default(ACTIVE)
  condition         AssetCondition @default(GOOD)
  assignedTo        String?
  notes             String?
  warrantyExpiry    DateTime?
  lastMaintenanceAt DateTime?
  nextMaintenanceAt DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  maintenanceLogs   MaintenanceLog[]

  @@index([category])
  @@index([status])
  @@index([condition])
  @@map("assets")
}

model MaintenanceLog {
  id              String   @id @default(uuid())
  assetId         String
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  maintenanceType String
  description     String
  performedBy     String?
  performedAt     DateTime
  cost            Float?
  nextDueDate     DateTime?
  notes           String?
  createdAt       DateTime @default(now())

  @@index([assetId])
  @@index([performedAt])
  @@map("maintenance_logs")
}

// Operations & Project Management System
enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

model Project {
  id              String          @id @default(uuid())
  projectCode     String          @unique
  name            String
  description     String?
  status          ProjectStatus   @default(PLANNING)
  priority        ProjectPriority @default(MEDIUM)
  location        String?
  startDate       DateTime
  endDate         DateTime?
  estimatedBudget Float?
  actualCost      Float           @default(0)
  progress        Int             @default(0)
  managerId       String?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  milestones      Milestone[]
  tasks           Task[]
  productionLogs  ProductionLog[]
  fieldReports    FieldReport[]
  payments        FinancePayment[]
  expenses        Expense[]
  budgets         Budget[]

  @@index([status])
  @@index([priority])
  @@index([startDate])
  @@map("projects")
}

model Milestone {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String
  description String?
  dueDate     DateTime
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([projectId])
  @@index([dueDate])
  @@map("milestones")
}

model Task {
  id          String     @id @default(uuid())
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String?
  status      TaskStatus @default(PENDING)
  assignedTo  String?
  dueDate     DateTime?
  isCompleted Boolean    @default(false)
  completedAt DateTime?
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([assignedTo])
  @@map("tasks")
}

// Production & Field Operations System
enum ShiftType {
  DAY
  NIGHT
  MORNING
  AFTERNOON
  EVENING
}

enum ProductionActivityType {
  MINING
  DRILLING
  BLASTING
  HAULING
  CRUSHING
  PROCESSING
  MAINTENANCE
  OTHER
}

model ProductionLog {
  id              String                 @id @default(uuid())
  projectId       String?
  project         Project?               @relation(fields: [projectId], references: [id])
  date            DateTime
  shiftType       ShiftType
  activityType    ProductionActivityType
  location        String?
  quantity        Float
  unit            String
  equipmentUsed   String?
  operatorName    String?
  notes           String?
  createdById     String
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  @@index([projectId])
  @@index([date])
  @@index([shiftType])
  @@map("production_logs")
}

model Shift {
  id          String    @id @default(uuid())
  date        DateTime
  shiftType   ShiftType
  startTime   String
  endTime     String
  supervisor  String?
  crew        String[]
  location    String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([date])
  @@index([shiftType])
  @@map("shifts")
}

model FieldReport {
  id          String   @id @default(uuid())
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  reportDate  DateTime
  location    String
  reportedBy  String
  title       String
  description String
  findings    String?
  recommendations String?
  priority    String   @default("MEDIUM")
  attachments String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([reportDate])
  @@map("field_reports")
}

// Finance & Procurement Models

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CHEQUE
  CASH
  MOBILE_MONEY
  CREDIT_CARD
  WIRE_TRANSFER
}

enum ExpenseCategory {
  OPERATIONS
  MAINTENANCE
  SALARIES
  SUPPLIES
  UTILITIES
  FUEL
  EQUIPMENT
  TRAVEL
  PROFESSIONAL_SERVICES
  TRAINING
  INSURANCE
  OTHER
}

enum BudgetPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

model FinancePayment {
  id              String        @id @default(uuid())
  paymentNumber   String        @unique
  supplierId      String?
  supplier        Supplier?     @relation(fields: [supplierId], references: [id])
  projectId       String?
  project         Project?      @relation(fields: [projectId], references: [id])
  amount          Float
  currency        String        @default("GHS")
  paymentMethod   PaymentMethod
  paymentDate     DateTime
  status          PaymentStatus @default(PENDING)
  reference       String?
  description     String
  category        String?
  approvedById    String?
  approvedBy      User?         @relation(fields: [approvedById], references: [id])
  notes           String?
  attachments     String[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([paymentNumber])
  @@index([supplierId])
  @@index([projectId])
  @@index([status])
  @@index([paymentDate])
  @@map("finance_payments")
}

model Expense {
  id              String          @id @default(uuid())
  expenseNumber   String          @unique
  category        ExpenseCategory
  projectId       String?
  project         Project?        @relation(fields: [projectId], references: [id])
  description     String
  amount          Float
  currency        String          @default("GHS")
  expenseDate     DateTime
  submittedById   String
  submittedBy     User            @relation("ExpenseSubmitter", fields: [submittedById], references: [id])
  approvedById    String?
  approvedBy      User?           @relation("ExpenseApprover", fields: [approvedById], references: [id])
  status          ApprovalStatus  @default(PENDING)
  receipt         String?
  notes           String?
  attachments     String[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([expenseNumber])
  @@index([category])
  @@index([projectId])
  @@index([status])
  @@index([expenseDate])
  @@map("expenses")
}

model Budget {
  id              String       @id @default(uuid())
  name            String
  description     String?
  category        ExpenseCategory
  projectId       String?
  project         Project?     @relation(fields: [projectId], references: [id])
  period          BudgetPeriod
  startDate       DateTime
  endDate         DateTime
  allocatedAmount Float
  spentAmount     Float        @default(0)
  currency        String       @default("GHS")
  createdById     String
  createdBy       User         @relation(fields: [createdById], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([category])
  @@index([projectId])
  @@index([period])
  @@index([startDate])
  @@map("budgets")
}

model Supplier {
  id              String           @id @default(uuid())
  supplierCode    String           @unique
  name            String
  contactPerson   String?
  email           String?
  phone           String?
  address         String?
  city            String?
  country         String           @default("Ghana")
  taxId           String?
  bankAccount     String?
  paymentTerms    String?
  category        String?
  rating          Int?
  isActive        Boolean          @default(true)
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  payments        FinancePayment[]

  @@index([supplierCode])
  @@index([isActive])
  @@map("suppliers")
}

// Knowledge Base & Documents
enum DocumentType {
  MANUAL
  SOP
  POLICY
  PROCEDURE
  REGULATION
  TRAINING
  REPORT
  OTHER
}

enum DocumentStatus {
  ACTIVE
  ARCHIVED
  DRAFT
}

model KnowledgeDocument {
  id          String         @id @default(uuid())
  title       String
  description String?
  type        DocumentType
  status      DocumentStatus @default(ACTIVE)
  content     String         @db.Text
  fileUrl     String?
  fileName    String?
  fileSize    Int?
  category    String?
  tags        String[]
  version     String?
  uploadedBy  String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([type])
  @@index([status])
  @@index([category])
  @@map("knowledge_documents")
}
