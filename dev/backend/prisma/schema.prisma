generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  SUPER_ADMIN
  CEO
  CFO
  DEPARTMENT_HEAD
  ACCOUNTANT
  PROCUREMENT_OFFICER
  OPERATIONS_MANAGER
  IT_MANAGER
  HR_MANAGER
  SAFETY_OFFICER
  WAREHOUSE_MANAGER
  EMPLOYEE
  VENDOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalType {
  INVOICE
  PURCHASE_REQUEST
  EXPENSE_CLAIM
  LEAVE_REQUEST
  PAYMENT
  IT_REQUEST
  PAYMENT_REQUEST
}

enum ProcurementApprovalType {
  SINGLE
  ALL
  MAJORITY
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RequisitionType {
  STOCK_REPLENISHMENT
  PROJECT_MATERIALS
  EQUIPMENT_PURCHASE
  MAINTENANCE_PARTS
  SAFETY_SUPPLIES
  CONSUMABLES
  EMERGENCY
  CAPITAL_EXPENDITURE
}

enum RequisitionStatus {
  DRAFT
  SUBMITTED
  PENDING_APPROVAL
  APPROVED
  PARTIALLY_APPROVED
  REJECTED
  CANCELLED
  IN_PROCUREMENT
  COMPLETED
}

enum NotificationType {
  APPROVAL_REQUEST
  APPROVAL_APPROVED
  APPROVAL_REJECTED
  APPROVAL_INFO_REQUEST
  SYSTEM_ALERT
  MENTION
}

enum ITRequestType {
  EQUIPMENT
  SOFTWARE
  ACCESS
  SUPPORT
  OTHER
}

enum PaymentType {
  VOUCHER
  REIMBURSEMENT
  ADVANCE
  PETTY_CASH
}

model User {
  id         String     @id @default(uuid())
  email      String     @unique
  password   String
  firstName  String
  lastName   String
  phone      String?
  role       UserRole   @default(EMPLOYEE)
  status     UserStatus @default(ACTIVE)
  department String?
  position   String?
  managerId  String?
  manager    User?      @relation("UserManager", fields: [managerId], references: [id])
  reports    User[]     @relation("UserManager")
  modulePermissions Json?
  mustChangePassword Boolean @default(false)
  vendorId   String?
  vendor     Vendor?    @relation("VendorPortalUser", fields: [vendorId], references: [id])
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  lastLogin  DateTime?

  // Relations
  createdInvoices         Invoice[]                 @relation("InvoiceCreator")
  createdPurchaseRequests PurchaseRequest[]         @relation("PurchaseRequestCreator")
  createdITRequests       ITRequest[]               @relation("ITRequestCreator")
  createdPaymentRequests  PaymentRequest[]          @relation("PaymentRequestCreator")
  approvalActions         ApprovalHistory[]         @relation("ApprovalActor")
  notifications           Notification[]            @relation("UserNotifications")
  assignedApprovals       UserAssignment[]          @relation("AssignedUser")
  approvedPayments        FinancePayment[]
  submittedExpenses       Expense[]                 @relation("ExpenseSubmitter")
  approvedExpenses        Expense[]                 @relation("ExpenseApprover")
  createdBudgets          Budget[]
  uploadedDocuments       Document[]                @relation("DocumentUploader")
  documentVersions        DocumentVersion[]         @relation("VersionUploader")
  documentSignatures      DocumentSignature[]       @relation("DocumentSigner")
  revokedSignatures       DocumentSignature[]       @relation("SignatureRevoker")
  documentAccessLogs      DocumentAccessLog[]       @relation("DocumentAccessor")
  createdSecurity         DocumentSecurity[]        @relation("SecurityCreator")
  ocrJobs                 OCRJob[]                  @relation("OCRJobCreator")
  conversionJobs          DocumentConversionJob[]   @relation("ConversionJobCreator")
  createdFormTemplates    DocumentFormTemplate[]    @relation("FormTemplateCreator")
  formDrafts              DocumentFormDraft[]       @relation("FormDraftCreator")
  auditPackageJobs        DocumentAuditPackageJob[] @relation("AuditPackageJobCreator")
  finalizeJobs            DocumentFinalizeJob[]     @relation("FinalizeJobCreator")
  integritySeals          DocumentIntegritySeal[]   @relation("IntegritySealCreator")
  importJobs              ImportJob[]               @relation("ImportCreator")
  exportJobs              ExportJob[]               @relation("ExportCreator")
  importTemplates         ImportTemplate[]          @relation("ImportTemplateCreator")
  csvAuditLogs            CsvAuditLog[]             @relation("CsvAuditCreator")
  csvBatches              CsvBatch[]                @relation("CsvBatchCreator")
  scheduledExports        ScheduledExport[]         @relation("ScheduledExportCreator")
  validatedData           ExtractedDocumentData[]   @relation("DataValidator")
  ocrConfigUpdates        OCRConfiguration[]        @relation("OCRConfigUpdater")

  requisitionsRequested          Requisition[]           @relation("RequisitionRequestor")
  requisitionsApproved           Requisition[]           @relation("RequisitionApprover")
  requisitionsRejected           Requisition[]           @relation("RequisitionRejecter")
  requisitionStageApprovals      RequisitionApproval[]   @relation("RequisitionStageApprover")
  requisitionAttachmentsUploaded RequisitionAttachment[] @relation("RequisitionAttachmentUploader")

  procurementWorkflowsCreated       ProcurementWorkflow[]      @relation("WorkflowCreator")
  procurementWorkflowStageApprovals ProcurementWorkflowStage[] @relation("StageApprover")
  procurementWorkflowEscalations    ProcurementWorkflowStage[] @relation("StageEscalationTarget")
  approvalDelegationsGiven          ApprovalDelegation[]       @relation("Delegator")
  approvalDelegationsReceived       ApprovalDelegation[]       @relation("Delegate")

  vendorsCreated          Vendor[]          @relation("VendorCreator")
  vendorDocumentsUploaded VendorDocument[]  @relation("VendorDocumentUploader")
  vendorEvaluations       VendorEvaluation[] @relation("VendorEvaluator")

  rfqsCreated RFQ[] @relation("RFQCreator")
  posCreated  PurchaseOrder[] @relation("POCreator")
  posApproved PurchaseOrder[] @relation("POApprover")

  goodsReceiptsReceived GoodsReceipt[] @relation("GoodsReceiver")
  qualityInspections    QualityInspection[] @relation("QualityInspector")
  vendorInvoicesMatched VendorInvoice[] @relation("InvoiceMatcher")
  vendorInvoicesApproved VendorInvoice[] @relation("VendorInvoiceApprover")
  vendorPaymentsProcessed VendorPayment[] @relation("PaymentProcessor")

  documentComments         DocumentComment[]    @relation("CommentAuthor")
  resolvedDocumentComments DocumentComment[]    @relation("CommentResolver")
  documentAnnotations      DocumentAnnotation[] @relation("AnnotationAuthor")
  documentSharesCreated    DocumentShare[]      @relation("ShareAuthor")
  documentSharesReceived   DocumentShare[]      @relation("ShareRecipient")
  documentPresence         DocumentPresence[]

  documentUserPermissions        DocumentUserPermission[]     @relation("DocumentUserAccess")
  grantedDocumentUserPermissions DocumentUserPermission[]     @relation("PermissionGranter")
  categoryPermissionsSet         DocumentCategoryPermission[] @relation("CategoryPermissionSetter")
  permissionTemplatesCreated     DocumentPermissionTemplate[] @relation("TemplateCreator")
  permissionLogsPerformed        DocumentPermissionLog[]      @relation("PermissionChanger")
  permissionLogsTarget           DocumentPermissionLog[]      @relation("PermissionTarget")

  fleetAssetsCreated      FleetAsset[]      @relation("FleetCreator")
  fleetAssetsOperated     FleetAsset[]      @relation("FleetAssetOperator")
  fleetAssignmentsAsOperator FleetAssignment[] @relation("FleetOperator")
  fleetAssignmentsAssigned   FleetAssignment[] @relation("FleetAssigner")
  fleetDocumentsUploaded  FleetDocument[]   @relation("FleetDocumentUploader")

  maintenancePerformed MaintenanceRecord[] @relation("MaintenancePerformer")
  maintenanceApproved  MaintenanceRecord[] @relation("MaintenanceApprover")
  maintenanceCreated   MaintenanceRecord[] @relation("MaintenanceCreator")

  breakdownsReported   BreakdownLog[]   @relation("BreakdownReporter")
  breakdownsAssigned   BreakdownLog[]   @relation("BreakdownAssignee")
  breakdownsResolved   BreakdownLog[]   @relation("BreakdownResolver")
  usageLogs            UsageLog[]       @relation("UsageOperator")
  fleetInspections     FleetInspection[] @relation("FleetInspector")
  fuelRecordsFilled    FuelRecord[]     @relation("FuelFiller")
  fuelRecordsApproved  FuelRecord[]     @relation("FuelApprover")
  fuelTankTransactions FuelTankTransaction[] @relation("TankTransactor")

  fleetCostsCreated    FleetCost[]      @relation("FleetCostCreator")
  fleetCostsApproved   FleetCost[]      @relation("FleetCostApprover")

  @@map("users")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  module      String
  action      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid())
  role         UserRole
  permissionId String
  createdAt    DateTime @default(now())

  @@unique([role, permissionId])
  @@map("role_permissions")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  module    String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Invoice {
  id              String            @id @default(uuid())
  invoiceNumber   String            @unique
  supplierName    String
  supplierEmail   String?
  description     String
  amount          Float
  currency        String            @default("GHS")
  dueDate         DateTime
  status          ApprovalStatus    @default(PENDING)
  createdById     String
  createdBy       User              @relation("InvoiceCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  attachmentUrl   String?
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("invoices")
}

model PurchaseRequest {
  id                 String            @id @default(uuid())
  requestNumber      String            @unique
  title              String
  description        String
  category           String
  quantity           Int
  estimatedCost      Float
  currency           String            @default("GHS")
  justification      String
  urgency            String            @default("NORMAL")
  status             ApprovalStatus    @default(PENDING)
  createdById        String
  createdBy          User              @relation("PurchaseRequestCreator", fields: [createdById], references: [id])
  approvalHistory    ApprovalHistory[]
  attachmentUrl      String?
  supplierSuggestion String?
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("purchase_requests")
}

model Requisition {
  id            String            @id @default(uuid())
  requisitionNo String            @unique
  title         String
  description   String?
  type          RequisitionType
  priority      Priority          @default(MEDIUM)
  status        RequisitionStatus @default(DRAFT)
  department    String
  projectId     String?
  project       Project?          @relation(fields: [projectId], references: [id])
  siteLocation  String
  requiredDate  DateTime
  justification String?
  totalEstimate Decimal           @default(0) @db.Decimal(15, 2)
  currency      String            @default("GHS")

  workflowId String?
  workflow   ProcurementWorkflow? @relation(fields: [workflowId], references: [id])

  requestedById String
  requestedBy   User   @relation("RequisitionRequestor", fields: [requestedById], references: [id])

  currentStage    Int       @default(1)
  approvedById    String?
  approvedBy      User?     @relation("RequisitionApprover", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectedById    String?
  rejectedBy      User?     @relation("RequisitionRejecter", fields: [rejectedById], references: [id])
  rejectedAt      DateTime?
  rejectionReason String?

  items           RequisitionItem[]
  attachments     RequisitionAttachment[]
  approvalHistory RequisitionApproval[]
  rfqs            RFQ[]
  purchaseOrders  PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([requestedById])
  @@index([department])
  @@map("requisitions")
}

model RequisitionItem {
  id              String      @id @default(uuid())
  requisitionId   String
  requisition     Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  itemName        String
  description     String?
  category        String
  quantity        Decimal     @db.Decimal(10, 2)
  unit            String
  estimatedPrice  Decimal     @db.Decimal(15, 2)
  totalPrice      Decimal     @db.Decimal(15, 2)
  specifications  String?
  preferredVendor String?
  stockItemId     String?
  stockItem       StockItem?  @relation(fields: [stockItemId], references: [id])
  urgency         Priority    @default(MEDIUM)
  notes           String?

  @@index([requisitionId])
  @@index([stockItemId])
  @@map("requisition_items")
}

model RequisitionAttachment {
  id            String      @id @default(uuid())
  requisitionId String
  requisition   Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  fileName      String
  fileUrl       String
  fileType      String
  uploadedById  String
  uploadedBy    User        @relation("RequisitionAttachmentUploader", fields: [uploadedById], references: [id])
  uploadedAt    DateTime    @default(now())

  @@index([requisitionId])
  @@index([uploadedById])
  @@map("requisition_attachments")
}

model RequisitionApproval {
  id            String         @id @default(uuid())
  requisitionId String
  requisition   Requisition    @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  stage         Int
  approverId    String
  approver      User           @relation("RequisitionStageApprover", fields: [approverId], references: [id])
  status        ApprovalStatus @default(PENDING)
  comments      String?
  actionAt      DateTime?

  createdAt DateTime @default(now())

  @@unique([requisitionId, stage, approverId])
  @@index([requisitionId, stage])
  @@index([approverId])
  @@map("requisition_approvals")
}

model ProcurementWorkflow {
  id          String           @id @default(uuid())
  name        String
  description String?
  type        RequisitionType?
  isActive    Boolean          @default(true)
  minAmount   Decimal?         @db.Decimal(15, 2)
  maxAmount   Decimal?         @db.Decimal(15, 2)

  stages ProcurementWorkflowStage[]

  createdById String
  createdBy   User     @relation("WorkflowCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  requisitions Requisition[]

  @@index([isActive])
  @@index([type])
  @@map("procurement_workflows")
}

model ProcurementWorkflowStage {
  id              String                  @id @default(uuid())
  workflowId      String
  workflow        ProcurementWorkflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stageNumber     Int
  name            String
  approverRole    UserRole?
  approverId      String?
  approver        User?                   @relation("StageApprover", fields: [approverId], references: [id])
  approvalType    ProcurementApprovalType @default(SINGLE)
  escalationHours Int?
  escalateToId    String?
  escalateTo      User?                   @relation("StageEscalationTarget", fields: [escalateToId], references: [id])

  @@unique([workflowId, stageNumber])
  @@index([workflowId])
  @@index([approverId])
  @@map("procurement_workflow_stages")
}

model ApprovalDelegation {
  id          String   @id @default(uuid())
  delegatorId String
  delegator   User     @relation("Delegator", fields: [delegatorId], references: [id])
  delegateId  String
  delegate    User     @relation("Delegate", fields: [delegateId], references: [id])
  startDate   DateTime
  endDate     DateTime
  reason      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([delegatorId])
  @@index([delegateId])
  @@index([isActive])
  @@map("approval_delegations")
}

enum VendorType {
  MANUFACTURER
  DISTRIBUTOR
  WHOLESALER
  RETAILER
  SERVICE_PROVIDER
  CONTRACTOR
}

enum VendorStatus {
  PENDING
  APPROVED
  SUSPENDED
  BLACKLISTED
  INACTIVE
}

model Vendor {
  id          String      @id @default(uuid())
  vendorCode  String      @unique
  companyName String
  tradingName String?
  type        VendorType
  category    String[]

  primaryContact String
  email          String
  phone          String
  alternatePhone String?
  website        String?

  address        String
  city           String
  region         String
  country        String      @default("Ghana")
  postalCode     String?
  gpsCoordinates String?

  taxId         String?
  businessRegNo String?
  vatRegistered Boolean     @default(false)
  vatNumber     String?

  bankName      String?
  bankBranch    String?
  accountNumber String?
  accountName   String?
  swiftCode     String?

  paymentTerms Int      @default(30)
  creditLimit  Decimal? @db.Decimal(15, 2)
  currency     String   @default("GHS")

  rating         Decimal @default(0) @db.Decimal(3, 2)
  totalOrders    Int     @default(0)
  totalSpend     Decimal @default(0) @db.Decimal(15, 2)
  onTimeDelivery Decimal @default(0) @db.Decimal(5, 2)
  qualityScore   Decimal @default(0) @db.Decimal(5, 2)

  status          VendorStatus @default(PENDING)
  isPreferred     Boolean      @default(false)
  isBlacklisted   Boolean      @default(false)
  blacklistReason String?

  miningLicense     String?
  environmentalCert String?
  safetyCompliance  Boolean  @default(false)
  insuranceCert     String?
  insuranceExpiry   DateTime?

  contacts    VendorContact[]
  documents   VendorDocument[]
  products    VendorProduct[]
  evaluations VendorEvaluation[]

  rfqInvites     RFQVendorInvite[]
  rfqResponses   RFQResponse[]
  purchaseOrders PurchaseOrder[]
  invoices       VendorInvoice[]
  portalUsers    User[] @relation("VendorPortalUser")
  maintenanceRecords MaintenanceRecord[]

  createdById String
  createdBy   User     @relation("VendorCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([isPreferred])
  @@index([isBlacklisted])
  @@map("vendors")
}

model VendorContact {
  id        String @id @default(uuid())
  vendorId  String
  vendor    Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  name      String
  position  String?
  email     String
  phone     String
  isPrimary Boolean @default(false)

  @@index([vendorId])
  @@map("vendor_contacts")
}

model VendorDocument {
  id          String   @id @default(uuid())
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  type        String
  name        String
  fileUrl     String
  expiryDate  DateTime?
  uploadedById String
  uploadedBy  User     @relation("VendorDocumentUploader", fields: [uploadedById], references: [id])
  uploadedAt  DateTime @default(now())

  @@index([vendorId])
  @@index([expiryDate])
  @@index([uploadedById])
  @@map("vendor_documents")
}

model VendorProduct {
  id           String  @id @default(uuid())
  vendorId     String
  vendor       Vendor  @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  productName  String
  category     String
  description  String?
  unitPrice    Decimal @db.Decimal(15, 2)
  unit         String
  leadTimeDays Int?
  minOrderQty  Decimal? @db.Decimal(10, 2)

  @@index([vendorId])
  @@map("vendor_products")
}

model VendorEvaluation {
  id             String   @id @default(uuid())
  vendorId       String
  vendor         Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  evaluatorId    String
  evaluator      User     @relation("VendorEvaluator", fields: [evaluatorId], references: [id])
  period         String
  qualityScore   Int
  deliveryScore  Int
  priceScore     Int
  serviceScore   Int
  safetyScore    Int
  overallScore   Decimal  @db.Decimal(3, 2)
  comments       String?
  recommendation String?
  evaluatedAt    DateTime @default(now())

  @@index([vendorId])
  @@index([evaluatorId])
  @@index([evaluatedAt])
  @@map("vendor_evaluations")
}

enum RFQStatus {
  DRAFT
  PUBLISHED
  CLOSED
  EVALUATING
  AWARDED
  CANCELLED
}

enum RFQResponseStatus {
  SUBMITTED
  UNDER_REVIEW
  SHORTLISTED
  SELECTED
  REJECTED
}

enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  ACKNOWLEDGED
  PARTIALLY_RECEIVED
  RECEIVED
  COMPLETED
  CANCELLED
}

enum PurchaseOrderPaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  OVERDUE
}

enum ReceiptStatus {
  PENDING_INSPECTION
  INSPECTING
  ACCEPTED
  PARTIALLY_ACCEPTED
  REJECTED
}

enum ItemCondition {
  GOOD
  DAMAGED
  DEFECTIVE
  WRONG_ITEM
}

enum InspectionResult {
  PASSED
  PASSED_WITH_NOTES
  FAILED
  PENDING_REVIEW
}

enum MatchStatus {
  PENDING
  MATCHED
  PARTIAL_MATCH
  MISMATCH
  DISPUTED
  RESOLVED
}

enum VendorInvoicePaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  OVERDUE
}

model RFQ {
  id               String     @id @default(uuid())
  rfqNumber        String     @unique
  title            String
  description      String?
  requisitionId    String?
  requisition      Requisition? @relation(fields: [requisitionId], references: [id])
  status           RFQStatus  @default(DRAFT)

  issueDate        DateTime?
  responseDeadline DateTime
  validityPeriod   Int        @default(30)

  deliveryLocation  String
  deliveryTerms     String?
  paymentTerms      String?
  specialConditions String?

  siteAccess          String?
  safetyRequirements  String?
  technicalSpecs      String?

  items          RFQItem[]
  invitedVendors RFQVendorInvite[]
  responses      RFQResponse[]
  selectedResponseId String?

  createdById String
  createdBy   User   @relation("RFQCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([requisitionId])
  @@map("rfqs")
}

model RFQItem {
  id             String   @id @default(uuid())
  rfqId          String
  rfq            RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  itemName       String
  description    String?
  specifications String?
  quantity       Decimal  @db.Decimal(10, 2)
  unit           String
  estimatedPrice Decimal? @db.Decimal(15, 2)

  responseItems  RFQResponseItem[]

  @@index([rfqId])
  @@map("rfq_items")
}

model RFQVendorInvite {
  id        String   @id @default(uuid())
  rfqId     String
  rfq       RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id])
  invitedAt DateTime @default(now())
  viewedAt  DateTime?
  status    String   @default("INVITED")

  @@unique([rfqId, vendorId])
  @@index([vendorId])
  @@map("rfq_vendor_invites")
}

model RFQResponse {
  id          String            @id @default(uuid())
  rfqId       String
  rfq         RFQ               @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  vendorId    String
  vendor      Vendor            @relation(fields: [vendorId], references: [id])
  status      RFQResponseStatus @default(SUBMITTED)

  totalAmount Decimal @db.Decimal(15, 2)
  currency    String  @default("GHS")
  validUntil  DateTime

  deliveryDays Int
  paymentTerms String?
  warranty     String?

  quotationDoc String?
  technicalDoc String?

  technicalScore  Decimal? @db.Decimal(5, 2)
  commercialScore Decimal? @db.Decimal(5, 2)
  overallScore    Decimal? @db.Decimal(5, 2)
  evaluationNotes String?

  items       RFQResponseItem[]
  purchaseOrders PurchaseOrder[]
  submittedAt DateTime @default(now())
  evaluatedAt DateTime?

  @@unique([rfqId, vendorId])
  @@index([vendorId])
  @@map("rfq_responses")
}

model RFQResponseItem {
  id           String      @id @default(uuid())
  responseId   String
  response     RFQResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  rfqItemId    String
  rfqItem      RFQItem     @relation(fields: [rfqItemId], references: [id])
  unitPrice    Decimal     @db.Decimal(15, 2)
  totalPrice   Decimal     @db.Decimal(15, 2)
  leadTimeDays Int?
  notes        String?

  @@index([responseId])
  @@index([rfqItemId])
  @@map("rfq_response_items")
}

model PurchaseOrder {
  id            String    @id @default(uuid())
  poNumber      String    @unique
  requisitionId String?
  requisition   Requisition? @relation(fields: [requisitionId], references: [id])
  rfqResponseId String?
  rfqResponse   RFQResponse? @relation(fields: [rfqResponseId], references: [id])

  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  status POStatus @default(DRAFT)

  subtotal       Decimal @db.Decimal(15, 2)
  taxAmount      Decimal @default(0) @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @db.Decimal(15, 2)
  shippingCost   Decimal @default(0) @db.Decimal(15, 2)
  totalAmount    Decimal @db.Decimal(15, 2)
  currency       String  @default("GHS")

  deliveryAddress  String
  deliverySite     String?
  expectedDelivery DateTime
  actualDelivery   DateTime?
  deliveryTerms    String?

  paymentTerms  Int                     @default(30)
  paymentStatus PurchaseOrderPaymentStatus @default(UNPAID)

  approvedById String?
  approvedBy   User? @relation("POApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  items PurchaseOrderItem[]

  receipts GoodsReceipt[]
  vendorInvoices VendorInvoice[]

  createdById String
  createdBy   User     @relation("POCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([vendorId])
  @@index([requisitionId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  itemName        String
  description     String?
  quantity        Decimal       @db.Decimal(10, 2)
  unit            String
  unitPrice       Decimal       @db.Decimal(15, 2)
  totalPrice      Decimal       @db.Decimal(15, 2)
  receivedQty     Decimal       @default(0) @db.Decimal(10, 2)
  stockItemId     String?
  stockItem       StockItem?    @relation(fields: [stockItemId], references: [id])

  goodsReceiptItems GoodsReceiptItem[]
  vendorInvoiceItems VendorInvoiceItem[]

  @@index([purchaseOrderId])
  @@index([stockItemId])
  @@map("purchase_order_items")
}

model GoodsReceipt {
  id              String        @id @default(uuid())
  grnNumber       String        @unique
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedDate    DateTime      @default(now())
  receivedById    String
  receivedBy      User          @relation("GoodsReceiver", fields: [receivedById], references: [id])

  warehouseId  String?
  siteLocation String

  deliveryNote  String?
  carrierName   String?
  vehicleNumber String?
  driverName    String?

  status ReceiptStatus @default(PENDING_INSPECTION)

  items       GoodsReceiptItem[]
  inspections QualityInspection[]

  notes     String?
  inventorySyncedAt DateTime?
  createdAt DateTime @default(now())

  @@index([purchaseOrderId])
  @@index([inventorySyncedAt])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id             String       @id @default(uuid())
  goodsReceiptId String
  goodsReceipt   GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  poItemId       String
  poItem         PurchaseOrderItem @relation(fields: [poItemId], references: [id])
  itemName       String
  orderedQty     Decimal      @db.Decimal(10, 2)
  receivedQty    Decimal      @db.Decimal(10, 2)
  acceptedQty    Decimal      @default(0) @db.Decimal(10, 2)
  rejectedQty    Decimal      @default(0) @db.Decimal(10, 2)
  unit           String
  condition      ItemCondition @default(GOOD)
  notes          String?

  @@index([goodsReceiptId])
  @@index([poItemId])
  @@map("goods_receipt_items")
}

model QualityInspection {
  id             String       @id @default(uuid())
  goodsReceiptId String
  goodsReceipt   GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  inspectorId    String
  inspector      User         @relation("QualityInspector", fields: [inspectorId], references: [id])
  inspectionDate DateTime     @default(now())

  overallResult InspectionResult
  qualityScore  Int?

  visualCheck   Boolean @default(false)
  quantityCheck Boolean @default(false)
  specCheck     Boolean @default(false)
  documentCheck Boolean @default(false)
  safetyCheck   Boolean @default(false)

  findings        String?
  recommendations String?
  photos          String[]

  @@index([goodsReceiptId])
  @@index([inspectorId])
  @@map("quality_inspections")
}

model VendorInvoice {
  id              String     @id @default(uuid())
  invoiceNumber   String
  vendorId        String
  vendor          Vendor     @relation(fields: [vendorId], references: [id])
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  subtotal    Decimal @db.Decimal(15, 2)
  taxAmount   Decimal @default(0) @db.Decimal(15, 2)
  totalAmount Decimal @db.Decimal(15, 2)
  currency    String  @default("GHS")

  invoiceDate  DateTime
  dueDate      DateTime
  receivedDate DateTime @default(now())

  matchStatus MatchStatus @default(PENDING)
  matchedAt   DateTime?
  matchedById String?
  matchedBy   User? @relation("InvoiceMatcher", fields: [matchedById], references: [id])

  priceVariance    Decimal @default(0) @db.Decimal(15, 2)
  quantityVariance Decimal @default(0) @db.Decimal(10, 2)
  discrepancyNotes String?

  approvedForPayment Boolean @default(false)
  approvedAt         DateTime?
  approvedById       String?
  approvedBy         User? @relation("VendorInvoiceApprover", fields: [approvedById], references: [id])

  paymentStatus VendorInvoicePaymentStatus @default(UNPAID)
  paidAmount    Decimal @default(0) @db.Decimal(15, 2)
  paidAt        DateTime?

  invoiceDocument String?

  items    VendorInvoiceItem[]
  payments VendorPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([vendorId, invoiceNumber])
  @@index([matchStatus])
  @@index([purchaseOrderId])
  @@map("vendor_invoices")
}

model VendorInvoiceItem {
  id          String       @id @default(uuid())
  invoiceId   String
  invoice     VendorInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Decimal      @db.Decimal(10, 2)
  unitPrice   Decimal      @db.Decimal(15, 2)
  totalPrice  Decimal      @db.Decimal(15, 2)
  poItemId    String?
  poItem      PurchaseOrderItem? @relation(fields: [poItemId], references: [id])

  @@index([invoiceId])
  @@index([poItemId])
  @@map("vendor_invoice_items")
}

model VendorPayment {
  id            String       @id @default(uuid())
  invoiceId     String
  invoice       VendorInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  amount        Decimal      @db.Decimal(15, 2)
  paymentDate   DateTime
  paymentMethod String
  reference     String?
  processedById String
  processedBy   User         @relation("PaymentProcessor", fields: [processedById], references: [id])
  notes         String?

  @@index([invoiceId])
  @@index([processedById])
  @@map("vendor_payments")
}

model ApprovalHistory {
  id            String         @id @default(uuid())
  type          ApprovalType
  referenceId   String
  approverLevel Int            @default(1)
  approverId    String
  approver      User           @relation("ApprovalActor", fields: [approverId], references: [id])
  action        ApprovalStatus
  comments      String?
  createdAt     DateTime       @default(now())

  // Relations to specific types
  invoice           Invoice?         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId         String?
  purchaseRequest   PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)
  purchaseRequestId String?

  // Relations for new types
  itRequest        ITRequest?      @relation(fields: [itRequestId], references: [id], onDelete: Cascade)
  itRequestId      String?
  paymentRequest   PaymentRequest? @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  paymentRequestId String?

  @@index([referenceId])
  @@index([approverId])
  @@index([createdAt])
  @@map("approval_history")
}

model ITRequest {
  id              String            @id @default(uuid())
  requestNumber   String            @unique
  requestType     ITRequestType
  title           String
  description     String
  priority        String            @default("NORMAL")
  status          ApprovalStatus    @default(PENDING)
  createdById     String
  createdBy       User              @relation("ITRequestCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  estimatedCost   Float?
  currency        String            @default("GHS")
  justification   String
  attachmentUrl   String?
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("it_requests")
}

model PaymentRequest {
  id              String            @id @default(uuid())
  requestNumber   String            @unique
  paymentType     PaymentType
  payeeName       String
  payeeAccount    String?
  description     String
  amount          Float
  currency        String            @default("GHS")
  status          ApprovalStatus    @default(PENDING)
  createdById     String
  createdBy       User              @relation("PaymentRequestCreator", fields: [createdById], references: [id])
  approvalHistory ApprovalHistory[]
  attachmentUrl   String?
  notes           String?
  dueDate         DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("payment_requests")
}

model Notification {
  id            String           @id @default(uuid())
  userId        String
  user          User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  type          NotificationType
  title         String
  message       String
  referenceId   String?
  referenceType String?
  read          Boolean          @default(false)
  createdAt     DateTime         @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model UserAssignment {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation("AssignedUser", fields: [userId], references: [id], onDelete: Cascade)
  itemType   String
  itemId     String
  assignedAt DateTime @default(now())

  @@unique([userId, itemType, itemId])
  @@index([userId])
  @@index([itemId])
  @@map("user_assignments")
}

// Workflow System
model ApprovalWorkflow {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        ApprovalType
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  stages    ApprovalStage[]
  instances WorkflowInstance[]

  @@index([type])
  @@index([isActive])
  @@map("approval_workflows")
}

model ApprovalStage {
  id            String           @id @default(uuid())
  workflowId    String
  workflow      ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stageOrder    Int
  stageName     String
  approverRoles String[]
  requiresAll   Boolean          @default(false)
  createdAt     DateTime         @default(now())

  stageActions StageAction[]

  @@unique([workflowId, stageOrder])
  @@index([workflowId])
  @@map("approval_stages")
}

model WorkflowInstance {
  id           String           @id @default(uuid())
  workflowId   String
  workflow     ApprovalWorkflow @relation(fields: [workflowId], references: [id])
  itemType     String
  itemId       String
  currentStage Int              @default(1)
  status       ApprovalStatus   @default(PENDING)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  stageActions StageAction[]

  @@unique([itemType, itemId])
  @@index([workflowId])
  @@index([itemId])
  @@map("workflow_instances")
}

model StageAction {
  id         String           @id @default(uuid())
  instanceId String
  instance   WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  stageId    String
  stage      ApprovalStage    @relation(fields: [stageId], references: [id])
  approverId String
  action     ApprovalStatus
  comments   String?
  createdAt  DateTime         @default(now())

  @@index([instanceId])
  @@index([stageId])
  @@map("stage_actions")
}

// Inventory & Asset Management System
enum StockUnit {
  PIECES
  KILOGRAMS
  LITERS
  METERS
  BOXES
  PALLETS
  TONS
  GALLONS
  UNITS
}

enum StockCategory {
  CONSUMABLES
  EQUIPMENT
  SPARE_PARTS
  TOOLS
  FUEL
  CHEMICALS
  SAFETY_GEAR
  OFFICE_SUPPLIES
  OTHER
}

enum MovementType {
  STOCK_IN
  STOCK_OUT
  ADJUSTMENT
  TRANSFER
  RETURN
  DAMAGED
  EXPIRED
}

model Warehouse {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  location    String
  description String?
  isActive    Boolean  @default(true)
  managerId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stockItems StockItem[]
  movements  StockMovement[]

  @@index([isActive])
  @@map("warehouses")
}

model StockItem {
  id              String        @id @default(uuid())
  itemCode        String        @unique
  name            String
  description     String?
  category        StockCategory
  unit            StockUnit
  unitPrice       Float?
  reorderLevel    Int           @default(0)
  maxStockLevel   Int?
  warehouseId     String
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id])
  currentQuantity Int           @default(0)
  reservedQuantity Int          @default(0)
  barcode         String?
  supplier        String?
  expiryDate      DateTime?
  lastRestockDate DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  movements        StockMovement[]
  requisitionItems RequisitionItem[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([category])
  @@index([warehouseId])
  @@index([currentQuantity])
  @@index([reservedQuantity])
  @@index([expiryDate])
  @@map("stock_items")
}

model StockMovement {
  id            String       @id @default(uuid())
  itemId        String
  item          StockItem    @relation(fields: [itemId], references: [id])
  warehouseId   String
  warehouse     Warehouse    @relation(fields: [warehouseId], references: [id])
  movementType  MovementType
  quantity      Int
  previousQty   Int
  newQty        Int
  unitPrice     Float?
  totalValue    Float?
  reference     String?
  notes         String?
  performedById String
  createdAt     DateTime     @default(now())

  @@index([itemId])
  @@index([warehouseId])
  @@index([movementType])
  @@index([createdAt])
  @@map("stock_movements")
}

// Asset Management System
enum AssetCategory {
  HEAVY_EQUIPMENT
  VEHICLES
  MACHINERY
  TOOLS
  COMPUTERS
  FURNITURE
  OTHER
}

enum AssetStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
  RETIRED
  DAMAGED
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  CRITICAL
}

model Asset {
  id                String         @id @default(uuid())
  assetCode         String         @unique
  name              String
  description       String?
  category          AssetCategory
  manufacturer      String?
  model             String?
  serialNumber      String?
  purchaseDate      DateTime
  purchasePrice     Float
  currentValue      Float?
  depreciationRate  Float?
  location          String?
  status            AssetStatus    @default(ACTIVE)
  condition         AssetCondition @default(GOOD)
  assignedTo        String?
  projectId         String?
  project           Project?       @relation(fields: [projectId], references: [id])
  notes             String?
  warrantyExpiry    DateTime?
  lastMaintenanceAt DateTime?
  nextMaintenanceAt DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  maintenanceLogs MaintenanceLog[]

  @@index([category])
  @@index([status])
  @@index([condition])
  @@index([projectId])
  @@map("assets")
}

model MaintenanceLog {
  id              String    @id @default(uuid())
  assetId         String
  asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  maintenanceType String
  description     String
  performedBy     String?
  performedAt     DateTime
  cost            Float?
  nextDueDate     DateTime?
  notes           String?
  createdAt       DateTime  @default(now())

  @@index([assetId])
  @@index([performedAt])
  @@map("maintenance_logs")
}

enum FleetAssetType {
  VEHICLE
  HEAVY_MACHINERY
  DRILLING_EQUIPMENT
  PROCESSING_EQUIPMENT
  SUPPORT_EQUIPMENT
  TRANSPORT
}

enum FuelType {
  DIESEL
  PETROL
  ELECTRIC
  HYBRID
  LPG
  NONE
}

enum FleetAssetStatus {
  ACTIVE
  IN_MAINTENANCE
  BREAKDOWN
  STANDBY
  DECOMMISSIONED
  SOLD
}

enum FleetAssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  CRITICAL
}

model FleetAsset {
  id                 String             @id @default(uuid())
  assetCode          String             @unique
  name               String
  type               FleetAssetType
  category           String

  registrationNo     String?
  serialNumber       String?
  engineNumber       String?
  chassisNumber      String?

  make               String
  model              String
  year               Int
  capacity           String?
  fuelType           FuelType
  tankCapacity       Decimal?           @db.Decimal(10, 2)

  purchaseDate       DateTime?
  purchasePrice      Decimal?           @db.Decimal(15, 2)
  vendor             String?
  warrantyExpiry     DateTime?

  status             FleetAssetStatus   @default(ACTIVE)
  condition          FleetAssetCondition @default(GOOD)
  currentLocation    String
  currentOperator    String?
  operatorId         String?
  operator           User?              @relation("FleetAssetOperator", fields: [operatorId], references: [id], onDelete: SetNull)

  currentOdometer    Decimal            @default(0) @db.Decimal(12, 2)
  currentHours       Decimal            @default(0) @db.Decimal(12, 2)
  lastOdometerUpdate DateTime?

  depreciationMethod String             @default("STRAIGHT_LINE")
  usefulLifeYears    Int                @default(10)
  salvageValue       Decimal            @default(0) @db.Decimal(15, 2)
  currentValue       Decimal?           @db.Decimal(15, 2)

  insuranceProvider  String?
  insurancePolicyNo  String?
  insuranceExpiry    DateTime?
  insurancePremium   Decimal?           @db.Decimal(15, 2)

  miningPermit       String?
  permitExpiry       DateTime?
  safetyInspection   DateTime?
  nextInspectionDue  DateTime?
  emissionsCert      String?
  emissionsExpiry    DateTime?

  decommissionReason String?
  decommissionedAt   DateTime?

  documents          FleetDocument[]
  assignments        FleetAssignment[]
  maintenanceSchedules MaintenanceSchedule[]
  maintenanceRecords   MaintenanceRecord[]

  breakdownLogs      BreakdownLog[]
  usageLogs          UsageLog[]
  inspections        FleetInspection[]
  fuelRecords        FuelRecord[]
  fuelTankTransactions FuelTankTransaction[]

  fleetCosts          FleetCost[]

  createdById        String
  createdBy          User               @relation("FleetCreator", fields: [createdById], references: [id])
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([type])
  @@index([status])
  @@index([currentLocation])
  @@map("fleet_assets")
}

model FleetDocument {
  id              String     @id @default(uuid())
  assetId         String
  asset           FleetAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  type            String
  name            String
  fileUrl         String
  storageKey      String
  storageProvider String     @default("local")
  expiryDate      DateTime?
  uploadedById    String
  uploadedBy      User       @relation("FleetDocumentUploader", fields: [uploadedById], references: [id])
  uploadedAt      DateTime   @default(now())

  @@index([assetId])
  @@index([expiryDate])
  @@map("fleet_documents")
}

model FleetAssignment {
  id           String     @id @default(uuid())
  assetId      String
  asset        FleetAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  operatorId   String
  operator     User       @relation("FleetOperator", fields: [operatorId], references: [id])
  projectId    String?
  project      Project?   @relation("FleetAssignmentProject", fields: [projectId], references: [id], onDelete: SetNull)
  siteLocation String
  startDate    DateTime
  endDate      DateTime?
  status       String     @default("ACTIVE")
  notes        String?

  assignedById String
  assignedBy   User       @relation("FleetAssigner", fields: [assignedById], references: [id])

  @@index([assetId])
  @@index([operatorId])
  @@index([projectId])
  @@index([status])
  @@map("fleet_assignments")
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  PREDICTIVE
  EMERGENCY
  INSPECTION
  OVERHAUL
}

enum ScheduleFrequency {
  TIME_BASED
  DISTANCE_BASED
  HOURS_BASED
  COMBINED
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

model MaintenanceSchedule {
  id               String            @id @default(uuid())
  assetId          String
  asset            FleetAsset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  type             MaintenanceType
  name             String
  description      String?

  records          MaintenanceRecord[]

  frequency        ScheduleFrequency
  intervalValue    Int
  intervalUnit     String

  lastPerformed    DateTime?
  lastOdometer     Decimal?          @db.Decimal(12, 2)
  lastHours        Decimal?          @db.Decimal(12, 2)
  nextDue          DateTime?
  nextDueOdometer  Decimal?          @db.Decimal(12, 2)
  nextDueHours     Decimal?          @db.Decimal(12, 2)

  alertDaysBefore  Int               @default(7)
  alertKmBefore    Decimal?          @db.Decimal(10, 2)
  alertHoursBefore Decimal?          @db.Decimal(10, 2)

  isActive         Boolean           @default(true)
  priority         Priority          @default(MEDIUM)

  estimatedCost     Decimal?         @db.Decimal(15, 2)
  estimatedDuration Int?

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([assetId])
  @@index([nextDue])
  @@index([isActive])
  @@map("maintenance_schedules")
}

model MaintenanceRecord {
  id               String            @id @default(uuid())
  assetId          String
  asset            FleetAsset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  scheduleId       String?
  schedule         MaintenanceSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)

  type             MaintenanceType
  title            String
  description      String?

  scheduledDate    DateTime?
  startDate        DateTime
  completionDate   DateTime?
  downtime         Decimal?          @db.Decimal(10, 2)

  odometerReading  Decimal?          @db.Decimal(12, 2)
  hoursReading     Decimal?          @db.Decimal(12, 2)

  workPerformed    String?
  partsReplaced    String?
  technicianNotes  String?

  laborCost        Decimal           @default(0) @db.Decimal(15, 2)
  partsCost        Decimal           @default(0) @db.Decimal(15, 2)
  externalCost     Decimal           @default(0) @db.Decimal(15, 2)
  totalCost        Decimal           @default(0) @db.Decimal(15, 2)

  serviceProvider  String?
  vendorId         String?
  vendor           Vendor?           @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  invoiceNumber    String?

  status           MaintenanceStatus @default(SCHEDULED)
  priority         Priority          @default(MEDIUM)

  performedById    String?
  performedBy      User?             @relation("MaintenancePerformer", fields: [performedById], references: [id], onDelete: SetNull)
  approvedById     String?
  approvedBy       User?             @relation("MaintenanceApprover", fields: [approvedById], references: [id], onDelete: SetNull)

  documents        String[]
  photos           String[]

  createdById      String
  createdBy        User              @relation("MaintenanceCreator", fields: [createdById], references: [id])
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  breakdownLogs    BreakdownLog[]

  @@index([assetId])
  @@index([scheduleId])
  @@index([status])
  @@map("maintenance_records")
}

model MaintenanceChecklist {
  id        String         @id @default(uuid())
  assetType FleetAssetType
  name      String
  items     Json
  isDefault Boolean        @default(false)
  createdAt DateTime       @default(now())

  @@index([assetType])
  @@map("maintenance_checklists")
}

enum BreakdownCategory {
  MECHANICAL
  ELECTRICAL
  HYDRAULIC
  ENGINE
  TRANSMISSION
  TIRES_TRACKS
  STRUCTURAL
  OPERATOR_ERROR
  EXTERNAL_DAMAGE
  OTHER
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum BreakdownStatus {
  REPORTED
  ACKNOWLEDGED
  DIAGNOSING
  AWAITING_PARTS
  IN_REPAIR
  RESOLVED
  CLOSED
}

model BreakdownLog {
  id                String           @id @default(uuid())
  assetId           String
  asset             FleetAsset       @relation(fields: [assetId], references: [id], onDelete: Cascade)

  breakdownDate     DateTime
  reportedDate      DateTime         @default(now())
  location          String
  siteLocation      String

  title             String
  description       String
  category          BreakdownCategory
  severity          Severity

  operationalImpact String?
  estimatedDowntime Decimal?         @db.Decimal(10, 2)
  actualDowntime    Decimal?         @db.Decimal(10, 2)
  productionLoss    Decimal?         @db.Decimal(15, 2)

  status            BreakdownStatus  @default(REPORTED)
  rootCause         String?
  resolution        String?
  resolvedDate      DateTime?

  repairType        String?
  repairCost        Decimal          @default(0) @db.Decimal(15, 2)
  partsUsed         String?

  reportedById      String
  reportedBy        User             @relation("BreakdownReporter", fields: [reportedById], references: [id])
  assignedToId      String?
  assignedTo        User?            @relation("BreakdownAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  resolvedById      String?
  resolvedBy        User?            @relation("BreakdownResolver", fields: [resolvedById], references: [id], onDelete: SetNull)

  photos            String[]
  documents         String[]

  maintenanceRecordId String?
  maintenanceRecord   MaintenanceRecord? @relation(fields: [maintenanceRecordId], references: [id], onDelete: SetNull)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([assetId])
  @@index([status])
  @@index([severity])
  @@index([category])
  @@map("breakdown_logs")
}

model UsageLog {
  id              String      @id @default(uuid())
  assetId         String
  asset           FleetAsset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  date            DateTime
  shiftId         String?
  shift           String?

  operatorId      String
  operator        User        @relation("UsageOperator", fields: [operatorId], references: [id])

  siteLocation    String
  projectId       String?
  project         Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)

  startOdometer   Decimal?    @db.Decimal(12, 2)
  endOdometer     Decimal?    @db.Decimal(12, 2)
  distanceCovered Decimal?    @db.Decimal(10, 2)

  startHours      Decimal?    @db.Decimal(12, 2)
  endHours        Decimal?    @db.Decimal(12, 2)
  operatingHours  Decimal?    @db.Decimal(10, 2)

  idleHours       Decimal?    @db.Decimal(10, 2)

  workDescription String?
  loadsCarried    Int?
  materialMoved   Decimal?    @db.Decimal(15, 2)
  tripsCompleted  Int?

  preOpCheck      Boolean     @default(false)
  postOpCheck     Boolean     @default(false)
  issuesReported  String?

  fuelAdded       Decimal?    @db.Decimal(10, 2)

  notes           String?
  createdAt       DateTime    @default(now())

  @@index([assetId])
  @@index([date])
  @@index([operatorId])
  @@index([siteLocation])
  @@map("usage_logs")
}

enum FuelTransactionType {
  FILL_UP
  PARTIAL_FILL
  TANK_DISPENSE
  EXTERNAL
}

enum FuelTankTransactionType {
  REFILL
  DISPENSE
  ADJUSTMENT
}

model FuelRecord {
  id                String              @id @default(uuid())
  assetId           String
  asset             FleetAsset          @relation(fields: [assetId], references: [id], onDelete: Cascade)

  transactionDate   DateTime
  transactionType   FuelTransactionType

  fuelType          FuelType
  quantity          Decimal             @db.Decimal(10, 2)
  unitPrice         Decimal             @db.Decimal(10, 4)
  totalCost         Decimal             @db.Decimal(15, 2)

  odometerReading   Decimal?            @db.Decimal(12, 2)
  hoursReading      Decimal?            @db.Decimal(12, 2)

  distanceSinceLast Decimal?            @db.Decimal(10, 2)
  hoursSinceLast    Decimal?            @db.Decimal(10, 2)
  fuelEfficiency    Decimal?            @db.Decimal(10, 4)

  fuelStation       String?
  receiptNumber     String?
  siteLocation      String

  filledById        String
  filledBy          User                @relation("FuelFiller", fields: [filledById], references: [id])
  approvedById      String?
  approvedBy        User?               @relation("FuelApprover", fields: [approvedById], references: [id], onDelete: SetNull)

  notes             String?
  receiptImage      String?

  createdAt         DateTime            @default(now())

  @@index([assetId])
  @@index([transactionDate])
  @@index([siteLocation])
  @@index([fuelType])
  @@map("fuel_records")
}

model FuelTank {
  id             String      @id @default(uuid())
  name           String
  location       String
  fuelType       FuelType
  capacity       Decimal     @db.Decimal(12, 2)
  currentLevel   Decimal     @db.Decimal(12, 2)
  reorderLevel   Decimal     @db.Decimal(12, 2)
  lastRefillDate DateTime?
  lastRefillQty  Decimal?    @db.Decimal(12, 2)
  status         String      @default("ACTIVE")

  transactions   FuelTankTransaction[]

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([location])
  @@index([fuelType])
  @@index([status])
  @@map("fuel_tanks")
}

model FuelTankTransaction {
  id              String                   @id @default(uuid())
  tankId          String
  tank            FuelTank                 @relation(fields: [tankId], references: [id], onDelete: Cascade)
  transactionType FuelTankTransactionType
  quantity        Decimal                  @db.Decimal(12, 2)
  balanceBefore   Decimal                  @db.Decimal(12, 2)
  balanceAfter    Decimal                  @db.Decimal(12, 2)
  assetId         String?
  asset           FleetAsset?              @relation(fields: [assetId], references: [id], onDelete: SetNull)
  reference       String?
  performedById   String
  performedBy     User                     @relation("TankTransactor", fields: [performedById], references: [id])
  transactionDate DateTime                 @default(now())
  notes           String?

  @@index([tankId])
  @@index([transactionDate])
  @@index([transactionType])
  @@map("fuel_tank_transactions")
}

enum FleetCostCategory {
  FUEL
  MAINTENANCE
  REPAIRS
  INSURANCE
  REGISTRATION
  PERMITS
  TIRES
  PARTS
  LABOR
  EXTERNAL_SERVICE
  DEPRECIATION
  OTHER
}

model FleetCost {
  id            String           @id @default(uuid())
  assetId       String
  asset         FleetAsset       @relation(fields: [assetId], references: [id], onDelete: Cascade)

  costDate      DateTime
  category      FleetCostCategory
  description   String
  amount        Decimal          @db.Decimal(15, 2)
  currency      String           @default("GHS")

  referenceType String?
  referenceId   String?

  approvedById  String?
  approvedBy    User?            @relation("FleetCostApprover", fields: [approvedById], references: [id], onDelete: SetNull)

  invoiceNumber String?
  receiptUrl    String?

  createdById   String
  createdBy     User             @relation("FleetCostCreator", fields: [createdById], references: [id])
  createdAt     DateTime         @default(now())

  @@index([assetId])
  @@index([category])
  @@index([costDate])
  @@map("fleet_costs")
}

enum FleetInspectionType {
  PRE_OPERATION
  POST_OPERATION
  WEEKLY
  MONTHLY
  SAFETY
  REGULATORY
}

model FleetInspection {
  id               String           @id @default(uuid())
  assetId          String
  asset            FleetAsset       @relation(fields: [assetId], references: [id], onDelete: Cascade)

  type             FleetInspectionType
  inspectionDate   DateTime

  inspectorId      String
  inspector        User             @relation("FleetInspector", fields: [inspectorId], references: [id])

  overallResult    InspectionResult
  score            Int?

  checklistItems   Json
  findings         String?
  recommendations  String?
  defectsFound     String[]

  followUpRequired Boolean          @default(false)
  followUpDate     DateTime?
  followUpNotes    String?

  photos           String[]
  documents        String[]

  createdAt        DateTime         @default(now())

  @@index([assetId])
  @@index([inspectionDate])
  @@index([type])
  @@map("fleet_inspections")
}

// Operations & Project Management System
enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

model Project {
  id              String          @id @default(uuid())
  projectCode     String          @unique
  name            String
  description     String?
  status          ProjectStatus   @default(PLANNING)
  priority        ProjectPriority @default(MEDIUM)
  location        String?
  startDate       DateTime
  endDate         DateTime?
  estimatedBudget Float?
  actualCost      Float           @default(0)
  progress        Int             @default(0)
  managerId       String?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  milestones     Milestone[]
  tasks          Task[]
  assets         Asset[]
  fleetAssignments FleetAssignment[] @relation("FleetAssignmentProject")
  requisitions   Requisition[]
  productionLogs ProductionLog[]
  fieldReports   FieldReport[]
  payments       FinancePayment[]
  expenses       Expense[]
  budgets        Budget[]
  usageLogs      UsageLog[]

  @@index([status])
  @@index([priority])
  @@index([startDate])
  @@map("projects")
}

model Milestone {
  id          String    @id @default(uuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String
  description String?
  dueDate     DateTime
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())

  @@index([projectId])
  @@index([dueDate])
  @@map("milestones")
}

model Task {
  id          String     @id @default(uuid())
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String?
  status      TaskStatus @default(PENDING)
  assignedTo  String?
  dueDate     DateTime?
  isCompleted Boolean    @default(false)
  completedAt DateTime?
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([assignedTo])
  @@map("tasks")
}

// Production & Field Operations System
enum ShiftType {
  DAY
  NIGHT
  MORNING
  AFTERNOON
  EVENING
}

enum ProductionActivityType {
  MINING
  DRILLING
  BLASTING
  HAULING
  CRUSHING
  PROCESSING
  MAINTENANCE
  OTHER
}

model ProductionLog {
  id            String                 @id @default(uuid())
  projectId     String?
  project       Project?               @relation(fields: [projectId], references: [id])
  date          DateTime
  shiftType     ShiftType
  activityType  ProductionActivityType
  location      String?
  quantity      Float
  unit          String
  equipmentUsed String?
  operatorName  String?
  notes         String?
  createdById   String
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  @@index([projectId])
  @@index([date])
  @@index([shiftType])
  @@map("production_logs")
}

model Shift {
  id         String    @id @default(uuid())
  date       DateTime
  shiftType  ShiftType
  startTime  String
  endTime    String
  supervisor String?
  crew       String[]
  location   String?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([date])
  @@index([shiftType])
  @@map("shifts")
}

model FieldReport {
  id              String   @id @default(uuid())
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  reportDate      DateTime
  location        String
  reportedBy      String
  title           String
  description     String
  findings        String?
  recommendations String?
  priority        String   @default("MEDIUM")
  attachments     String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId])
  @@index([reportDate])
  @@map("field_reports")
}

// Finance & Procurement Models

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CHEQUE
  CASH
  MOBILE_MONEY
  CREDIT_CARD
  WIRE_TRANSFER
}

enum ExpenseCategory {
  OPERATIONS
  MAINTENANCE
  SALARIES
  SUPPLIES
  UTILITIES
  FUEL
  EQUIPMENT
  TRAVEL
  PROFESSIONAL_SERVICES
  TRAINING
  INSURANCE
  OTHER
}

enum BudgetPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

model FinancePayment {
  id            String        @id @default(uuid())
  paymentNumber String        @unique
  supplierId    String?
  supplier      Supplier?     @relation(fields: [supplierId], references: [id])
  projectId     String?
  project       Project?      @relation(fields: [projectId], references: [id])
  amount        Float
  currency      String        @default("GHS")
  paymentMethod PaymentMethod
  paymentDate   DateTime
  status        PaymentStatus @default(PENDING)
  reference     String?
  description   String
  category      String?
  approvedById  String?
  approvedBy    User?         @relation(fields: [approvedById], references: [id])
  notes         String?
  attachments   String[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([paymentNumber])
  @@index([supplierId])
  @@index([projectId])
  @@index([status])
  @@index([paymentDate])
  @@map("finance_payments")
}

model Expense {
  id            String          @id @default(uuid())
  expenseNumber String          @unique
  category      ExpenseCategory
  projectId     String?
  project       Project?        @relation(fields: [projectId], references: [id])
  description   String
  amount        Float
  currency      String          @default("GHS")
  expenseDate   DateTime
  submittedById String
  submittedBy   User            @relation("ExpenseSubmitter", fields: [submittedById], references: [id])
  approvedById  String?
  approvedBy    User?           @relation("ExpenseApprover", fields: [approvedById], references: [id])
  status        ApprovalStatus  @default(PENDING)
  receipt       String?
  notes         String?
  attachments   String[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([expenseNumber])
  @@index([category])
  @@index([projectId])
  @@index([status])
  @@index([expenseDate])
  @@map("expenses")
}

model Budget {
  id              String          @id @default(uuid())
  name            String
  description     String?
  category        ExpenseCategory
  projectId       String?
  project         Project?        @relation(fields: [projectId], references: [id])
  period          BudgetPeriod
  startDate       DateTime
  endDate         DateTime
  allocatedAmount Float
  spentAmount     Float           @default(0)
  currency        String          @default("GHS")
  createdById     String
  createdBy       User            @relation(fields: [createdById], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([category])
  @@index([projectId])
  @@index([period])
  @@index([startDate])
  @@map("budgets")
}

model Supplier {
  id            String           @id @default(uuid())
  supplierCode  String           @unique
  name          String
  contactPerson String?
  email         String?
  phone         String?
  address       String?
  city          String?
  country       String           @default("Ghana")
  taxId         String?
  bankAccount   String?
  paymentTerms  String?
  category      String?
  rating        Int?
  isActive      Boolean          @default(true)
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  payments      FinancePayment[]

  @@index([supplierCode])
  @@index([isActive])
  @@map("suppliers")
}

// Knowledge Base & Documents
enum DocumentType {
  MANUAL
  SOP
  POLICY
  PROCEDURE
  REGULATION
  TRAINING
  REPORT
  OTHER
}

enum DocumentStatus {
  ACTIVE
  ARCHIVED
  DRAFT
}

model KnowledgeDocument {
  id          String         @id @default(uuid())
  title       String
  description String?
  type        DocumentType
  status      DocumentStatus @default(ACTIVE)
  content     String         @db.Text
  fileUrl     String?
  fileName    String?
  fileSize    Int?
  category    String?
  tags        String[]
  version     String?
  uploadedBy  String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([type])
  @@index([status])
  @@index([category])
  @@map("knowledge_documents")
}

// Safety & Incident Management
enum IncidentSeverity {
  MINOR
  MODERATE
  SERIOUS
  CRITICAL
  FATAL
}

enum IncidentType {
  INJURY
  NEAR_MISS
  EQUIPMENT_DAMAGE
  ENVIRONMENTAL
  SECURITY
  FIRE
  CHEMICAL_SPILL
  OTHER
}

enum IncidentStatus {
  REPORTED
  INVESTIGATING
  RESOLVED
  CLOSED
}

model SafetyIncident {
  id                String           @id @default(uuid())
  incidentNumber    String           @unique
  type              IncidentType
  severity          IncidentSeverity
  status            IncidentStatus   @default(REPORTED)
  location          String
  incidentDate      DateTime
  reportedBy        String
  reportedAt        DateTime         @default(now())
  description       String           @db.Text
  injuries          String?          @db.Text
  witnesses         String[]
  photoUrls         String[]
  aiAnalysis        String?          @db.Text
  rootCause         String?          @db.Text
  correctiveActions String?          @db.Text
  oshaReportable    Boolean          @default(false)
  oshaReport        String?          @db.Text
  investigatedBy    String?
  investigatedAt    DateTime?
  resolvedAt        DateTime?
  notes             String?          @db.Text
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([incidentDate])
  @@map("safety_incidents")
}

// HR & Personnel Management
enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  TERMINATED
  RETIRED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERN
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  ON_LEAVE
}

enum LeaveType {
  ANNUAL
  SICK
  PERSONAL
  MATERNITY
  PATERNITY
  UNPAID
  EMERGENCY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ReviewRating {
  OUTSTANDING
  EXCEEDS_EXPECTATIONS
  MEETS_EXPECTATIONS
  NEEDS_IMPROVEMENT
  UNSATISFACTORY
}

model Employee {
  id          String    @id @default(uuid())
  employeeId  String    @unique
  firstName   String
  lastName    String
  email       String    @unique
  phone       String?
  dateOfBirth DateTime?
  gender      String?
  address     String?
  city        String?
  country     String    @default("Ghana")

  // Employment Details
  department      String
  position        String
  employmentType  EmploymentType   @default(FULL_TIME)
  status          EmploymentStatus @default(ACTIVE)
  hireDate        DateTime
  terminationDate DateTime?
  salary          Float?
  supervisorId    String?

  // Emergency Contact
  emergencyContact String?
  emergencyPhone   String?

  // Documents & Notes
  documents String[]
  notes     String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  attendances        Attendance[]
  leaveRequests      LeaveRequest[]
  performanceReviews PerformanceReview[]

  @@index([employeeId])
  @@index([department])
  @@index([status])
  @@map("employees")
}

model Attendance {
  id         String           @id @default(uuid())
  employeeId String
  employee   Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date       DateTime
  status     AttendanceStatus
  checkIn    DateTime?
  checkOut   DateTime?
  workHours  Float?
  notes      String?
  markedBy   String?
  createdAt  DateTime         @default(now())

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@map("attendances")
}

model LeaveRequest {
  id              String      @id @default(uuid())
  employeeId      String
  employee        Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType       LeaveType
  startDate       DateTime
  endDate         DateTime
  totalDays       Int
  reason          String      @db.Text
  status          LeaveStatus @default(PENDING)
  approvedById    String?
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@map("leave_requests")
}

model PerformanceReview {
  id           String   @id @default(uuid())
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  reviewPeriod String
  reviewDate   DateTime
  reviewerId   String
  reviewerName String

  // Performance Metrics
  overallRating   ReviewRating
  technicalSkills Float?
  communication   Float?
  teamwork        Float?
  productivity    Float?
  leadership      Float?

  strengths           String? @db.Text
  areasForImprovement String? @db.Text
  goals               String? @db.Text
  comments            String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([reviewDate])
  @@map("performance_reviews")
}

// Recruitment & Talent Acquisition
enum JobStatus {
  DRAFT
  OPEN
  CLOSED
  ON_HOLD
  FILLED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERN
}

enum ApplicationStatus {
  SUBMITTED
  SCREENING
  SHORTLISTED
  INTERVIEW_SCHEDULED
  INTERVIEWED
  OFFERED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  RESCHEDULED
}

model JobPosting {
  id         String    @id @default(uuid())
  jobId      String    @unique
  title      String
  department String
  location   String
  jobType    JobType
  status     JobStatus @default(DRAFT)

  // Job Details
  description      String @db.Text
  requirements     String @db.Text
  responsibilities String @db.Text
  qualifications   String @db.Text

  // Compensation
  salaryMin Float?
  salaryMax Float?
  benefits  String? @db.Text

  // Dates
  openDate  DateTime?
  closeDate DateTime?

  // AI Generated
  aiGenerated Boolean @default(false)
  aiPrompt    String? @db.Text

  postedBy  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  applications Application[]

  @@index([status])
  @@index([department])
  @@index([jobType])
  @@map("job_postings")
}

model Candidate {
  id          String  @id @default(uuid())
  candidateId String  @unique
  firstName   String
  lastName    String
  email       String  @unique
  phone       String?

  // Resume/CV
  resumeUrl  String?
  resumeText String? @db.Text
  cvParsed   Boolean @default(false)

  // Parsed Information
  skills          String[]
  experience      String?  @db.Text
  education       String?  @db.Text
  currentPosition String?
  currentCompany  String?
  yearsExperience Int?

  // AI Analysis
  aiSummary         String? @db.Text
  aiSkillMatch      Float?
  aiExperienceMatch Float?
  aiCultureFit      Float?

  linkedinUrl  String?
  portfolioUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  applications Application[]
  interviews   Interview[]

  @@index([email])
  @@map("candidates")
}

model Application {
  id           String     @id @default(uuid())
  jobPostingId String
  jobPosting   JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  candidateId  String
  candidate    Candidate  @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  status      ApplicationStatus @default(SUBMITTED)
  coverLetter String?           @db.Text

  // AI Screening
  aiScreened       Boolean  @default(false)
  aiScore          Float?
  aiRecommendation String?  @db.Text
  aiStrengths      String[]
  aiWeaknesses     String[]

  // Ranking
  overallScore Float?
  rank         Int?

  // Dates
  appliedAt  DateTime  @default(now())
  screenedAt DateTime?
  reviewedBy String?
  reviewedAt DateTime?

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  interviews Interview[]

  @@unique([jobPostingId, candidateId])
  @@index([jobPostingId])
  @@index([candidateId])
  @@index([status])
  @@map("applications")
}

model Interview {
  id            String      @id @default(uuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  candidateId   String
  candidate     Candidate   @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  interviewType String
  scheduledDate DateTime
  duration      Int
  location      String?
  meetingLink   String?

  interviewers String[]
  status       InterviewStatus @default(SCHEDULED)

  // Interview Results
  completed Boolean @default(false)
  feedback  String? @db.Text
  rating    Float?

  // AI Summary
  aiSummary        String?  @db.Text
  aiKeyPoints      String[]
  aiRecommendation String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([applicationId])
  @@index([candidateId])
  @@index([scheduledDate])
  @@map("interviews")
}

// Safety & Compliance Module
enum InspectionType {
  EQUIPMENT
  VEHICLE
  FACILITY
  WORKPLACE
  FIRE_SAFETY
  ELECTRICAL
  CONFINED_SPACE
  CHEMICAL_STORAGE
}

enum InspectionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
  PASSED
}

enum TrainingType {
  SAFETY_ORIENTATION
  EQUIPMENT_OPERATION
  EMERGENCY_RESPONSE
  FIRST_AID
  FIRE_SAFETY
  CONFINED_SPACE
  HAZARDOUS_MATERIALS
  PPE_USAGE
  INCIDENT_REPORTING
}

enum TrainingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum CertificationStatus {
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  SUSPENDED
  REVOKED
}

enum DrillType {
  FIRE_EVACUATION
  EMERGENCY_EVACUATION
  SPILL_RESPONSE
  RESCUE_OPERATION
  MEDICAL_EMERGENCY
}

model SafetyInspection {
  id           String           @id @default(uuid())
  inspectionId String           @unique
  type         InspectionType
  status       InspectionStatus @default(SCHEDULED)

  // What is being inspected
  title       String
  location    String
  equipmentId String?
  assetId     String?

  // Inspection details
  scheduledDate DateTime
  completedDate DateTime?
  inspectedBy   String?
  inspectorName String?

  // Results
  passed          Boolean?
  score           Float?
  findings        String?  @db.Text
  deficiencies    String[]
  recommendations String?  @db.Text
  actionRequired  Boolean  @default(false)

  // Corrective actions
  correctiveActions String?   @db.Text
  dueDate           DateTime?
  resolvedDate      DateTime?
  resolvedBy        String?

  // Documentation
  checklistItems String[]
  photoUrls      String[]
  documentUrls   String[]
  notes          String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([scheduledDate])
  @@map("safety_inspections")
}

model SafetyTraining {
  id         String         @id @default(uuid())
  trainingId String         @unique
  type       TrainingType
  status     TrainingStatus @default(SCHEDULED)

  // Training details
  title           String
  description     String? @db.Text
  location        String?
  duration        Int
  maxParticipants Int?

  // Scheduling
  scheduledDate DateTime
  startTime     String?
  endTime       String?

  // Instructor
  instructorId   String?
  instructorName String

  // Participants
  participants    String[]
  completedBy     String[]
  attendanceCount Int?

  // Results
  passingScore  Float?
  completed     Boolean   @default(false)
  completedDate DateTime?

  // Content
  topics         String[]
  materials      String[]
  certificateUrl String?

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([scheduledDate])
  @@map("safety_trainings")
}

model SafetyCertification {
  id              String @id @default(uuid())
  certificationId String @unique

  // Employee
  employeeId   String
  employeeName String

  // Certification details
  certType    String
  certName    String
  certNumber  String?
  issuingBody String

  // Dates
  issueDate   DateTime
  expiryDate  DateTime
  renewalDate DateTime?

  status CertificationStatus @default(ACTIVE)

  // Verification
  verifiedBy   String?
  verifiedDate DateTime?

  // Documentation
  certificateUrl String?
  documentUrls   String[]

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([expiryDate])
  @@map("safety_certifications")
}

model SafetyDrill {
  id      String    @id @default(uuid())
  drillId String    @unique
  type    DrillType

  // Drill details
  title       String
  description String? @db.Text
  location    String

  // Scheduling
  scheduledDate DateTime
  startTime     String?
  endTime       String?
  duration      Int?

  // Participants
  expectedCount Int?
  actualCount   Int?
  participants  String[]

  // Coordination
  coordinator     String
  coordinatorName String
  observers       String[]

  // Results
  completed     Boolean   @default(false)
  completedDate DateTime?
  successRating Float?

  // Evaluation
  objectives          String[]
  results             String?  @db.Text
  strengths           String[]
  areasForImprovement String[]
  lessonsLearned      String?  @db.Text

  // Follow-up
  followUpActions String? @db.Text
  actionRequired  Boolean @default(false)

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([scheduledDate])
  @@map("safety_drills")
}

// System Settings & Integrations
model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  isSecret  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// Document Management System (Phase 15.1)
enum DocumentCategory {
  INVOICE
  RECEIPT
  PURCHASE_ORDER
  QUOTATION
  CONTRACT
  SAFETY_REPORT
  INCIDENT_REPORT
  COMPLIANCE_DOC
  PROJECT_REPORT
  HR_DOCUMENT
  PAYROLL
  TAX_FORM
  AUDIT_DOCUMENT
  TRAINING_MATERIAL
  CERTIFICATE
  EQUIPMENT_MANUAL
  OTHER
}

model Document {
  id           String           @id @default(uuid())
  fileName     String
  originalName String
  fileSize     Int
  mimeType     String
  fileUrl      String
  fileHash     String?
  category     DocumentCategory
  module       String
  referenceId  String?
  description  String?
  tags         String[]
  version      Int              @default(1)
  isLatest     Boolean          @default(true)
  uploadedById String
  uploadedBy   User             @relation("DocumentUploader", fields: [uploadedById], references: [id])
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  versions              DocumentVersion[]
  metadata              DocumentMetadata?
  permissions           DocumentPermission[]
  userPermissions       DocumentUserPermission[]
  departmentPermissions DocumentDepartmentPermission[]
  permissionLogs        DocumentPermissionLog[]
  signatures            DocumentSignature[]            @relation("DocumentSignatures")
  security              DocumentSecurity?              @relation("DocumentSecurity")

  comments               DocumentComment[]
  annotations            DocumentAnnotation[]
  shares                 DocumentShare[]
  presence               DocumentPresence[]
  aiInsight              DocumentAiInsight?
  conversionJobs         DocumentConversionJob[]
  formTemplates          DocumentFormTemplate[]
  formDrafts             DocumentFormDraft[]
  auditPackageOutputJobs DocumentAuditPackageJob[] @relation("AuditPackageOutputDocument")
  finalizeJobs           DocumentFinalizeJob[]
  integritySeals         DocumentIntegritySeal[]

  @@index([module, referenceId])
  @@index([category])
  @@index([uploadedById])
  @@index([fileHash])
  @@map("documents")
}

// Phase 16.4: AI-Powered Document Intelligence
model DocumentAiInsight {
  id         String   @id @default(uuid())
  documentId String   @unique
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  provider String?
  model    String?

  summary           String?           @db.Text
  entities          Json?
  suggestedCategory DocumentCategory?
  suggestedTags     String[]          @default([])
  anomalies         Json?
  linkedRecords     Json?

  // Optional embeddings used for semantic search and similarity
  embedding Float[] @default([])

  analyzedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([analyzedAt])
  @@map("document_ai_insights")
}

model DocumentVersion {
  id            String   @id @default(uuid())
  documentId    String
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  versionNumber Int
  fileName      String
  fileUrl       String
  fileSize      Int
  uploadedById  String
  uploadedBy    User     @relation("VersionUploader", fields: [uploadedById], references: [id])
  changeNotes   String?
  createdAt     DateTime @default(now())

  @@unique([documentId, versionNumber])
  @@map("document_versions")
}

model DocumentMetadata {
  id            String    @id @default(uuid())
  documentId    String    @unique
  document      Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  pageCount     Int?
  author        String?
  title         String?
  subject       String?
  keywords      String[]  @default([])
  createdDate   DateTime?
  modifiedDate  DateTime?
  extractedText String?   @db.Text

  @@map("document_metadata")
}

model DocumentPermission {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  role       UserRole
  canView    Boolean  @default(false)
  canEdit    Boolean  @default(false)
  canDelete  Boolean  @default(false)
  canShare   Boolean  @default(false)
  canSign    Boolean  @default(false)

  @@unique([documentId, role])
  @@map("document_permissions")
}

model DocumentUserPermission {
  id          String    @id @default(uuid())
  documentId  String
  document    Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation("DocumentUserAccess", fields: [userId], references: [id], onDelete: Cascade)
  canView     Boolean   @default(true)
  canEdit     Boolean   @default(false)
  canDelete   Boolean   @default(false)
  canShare    Boolean   @default(false)
  canSign     Boolean   @default(false)
  grantedById String
  grantedBy   User      @relation("PermissionGranter", fields: [grantedById], references: [id])
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([documentId, userId])
  @@index([userId])
  @@map("document_user_permissions")
}

model DocumentDepartmentPermission {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  department String
  canView    Boolean  @default(true)
  canEdit    Boolean  @default(false)
  canDelete  Boolean  @default(false)
  canShare   Boolean  @default(false)
  canSign    Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@unique([documentId, department])
  @@map("document_department_permissions")
}

model DocumentCategoryPermission {
  id        String           @id @default(uuid())
  category  DocumentCategory
  role      UserRole
  canView   Boolean          @default(false)
  canEdit   Boolean          @default(false)
  canDelete Boolean          @default(false)
  canShare  Boolean          @default(false)
  canSign   Boolean          @default(false)
  canUpload Boolean          @default(false)
  setById   String
  setBy     User             @relation("CategoryPermissionSetter", fields: [setById], references: [id])
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([category, role])
  @@map("document_category_permissions")
}

model DocumentPermissionTemplate {
  id          String            @id @default(uuid())
  name        String            @unique
  description String?
  category    DocumentCategory?
  module      String?
  roles       Json
  departments Json?
  isDefault   Boolean           @default(false)
  createdById String
  createdBy   User              @relation("TemplateCreator", fields: [createdById], references: [id])
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("document_permission_templates")
}

enum PermissionAction {
  GRANT
  REVOKE
  MODIFY
  TEMPLATE_APPLIED
  BULK_UPDATE
}

model DocumentPermissionLog {
  id               String            @id @default(uuid())
  documentId       String?
  document         Document?         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  category         DocumentCategory?
  action           PermissionAction
  performedById    String
  performedBy      User              @relation("PermissionChanger", fields: [performedById], references: [id])
  targetUserId     String?
  targetUser       User?             @relation("PermissionTarget", fields: [targetUserId], references: [id])
  targetRole       UserRole?
  targetDepartment String?
  oldPermissions   Json?
  newPermissions   Json
  reason           String?
  ipAddress        String
  createdAt        DateTime          @default(now())

  @@index([documentId])
  @@index([performedById])
  @@index([createdAt])
  @@map("document_permission_logs")
}

// Phase 15.4: Digital Signatures & Document Security
enum SignatureType {
  DRAWN // Hand-drawn signature
  TYPED // Typed name
  UPLOADED // Uploaded signature image
  CERTIFICATE // Digital certificate (future)
}

enum DocumentAction {
  VIEWED
  DOWNLOADED
  EDITED
  DELETED
  SHARED
  SIGNED
  PERMISSION_CHANGED
  SECURITY_UPDATED
}

model DocumentSignature {
  id            String        @id @default(uuid())
  documentId    String
  document      Document      @relation("DocumentSignatures", fields: [documentId], references: [id], onDelete: Cascade)
  signerId      String
  signer        User          @relation("DocumentSigner", fields: [signerId], references: [id])
  signatureData String        @db.Text // Base64 encoded signature image
  signatureType SignatureType @default(DRAWN)
  signatureHash String // Hash of signature for verification
  ipAddress     String
  userAgent     String
  location      String? // GPS coordinates if available
  reason        String? // Reason for signing (e.g., "Approved invoice")
  metadata      Json? // Additional metadata (device info, etc.)
  isValid       Boolean       @default(true)
  revokedAt     DateTime?
  revokedById   String?
  revokedBy     User?         @relation("SignatureRevoker", fields: [revokedById], references: [id])
  revokeReason  String?
  signedAt      DateTime      @default(now())

  @@index([documentId])
  @@index([signerId])
  @@index([signedAt])
  @@map("document_signatures")
}

model DocumentAccessLog {
  id         String         @id @default(uuid())
  documentId String
  userId     String
  user       User           @relation("DocumentAccessor", fields: [userId], references: [id])
  action     DocumentAction
  ipAddress  String
  userAgent  String
  metadata   Json? // Additional context (e.g., download format, edit details)
  accessedAt DateTime       @default(now())

  @@index([documentId])
  @@index([userId])
  @@index([accessedAt])
  @@map("document_access_logs")
}

model DocumentSecurity {
  id                  String    @id @default(uuid())
  documentId          String    @unique
  document            Document  @relation("DocumentSecurity", fields: [documentId], references: [id], onDelete: Cascade)
  isPasswordProtected Boolean   @default(false)
  passwordHash        String? // Hashed password for PDF protection
  hasWatermark        Boolean   @default(false)
  watermarkText       String?
  isEncrypted         Boolean   @default(false)
  encryptionKey       String? // Encrypted key for sensitive documents
  expiresAt           DateTime? // Document access expiration
  maxDownloads        Int? // Maximum number of downloads allowed
  downloadCount       Int       @default(0)
  requireSignature    Boolean   @default(false)
  allowPrint          Boolean   @default(true)
  allowCopy           Boolean   @default(true)
  createdById         String
  createdBy           User      @relation("SecurityCreator", fields: [createdById], references: [id])
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("document_security")
}

// Phase 16.3: Document Collaboration & Annotations
enum AnnotationType {
  HIGHLIGHT
  UNDERLINE
  STRIKETHROUGH
  NOTE
  ARROW
  RECTANGLE
  TEXT
}

model DocumentComment {
  id           String            @id @default(uuid())
  documentId   String
  document     Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  authorId     String
  author       User              @relation("CommentAuthor", fields: [authorId], references: [id])
  content      String
  pageNumber   Int?
  positionX    Float?
  positionY    Float?
  isResolved   Boolean           @default(false)
  resolvedById String?
  resolvedBy   User?             @relation("CommentResolver", fields: [resolvedById], references: [id])
  resolvedAt   DateTime?
  parentId     String?
  parent       DocumentComment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies      DocumentComment[] @relation("CommentThread")
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([documentId])
  @@index([parentId])
  @@index([isResolved])
  @@map("document_comments")
}

model DocumentAnnotation {
  id          String         @id @default(uuid())
  documentId  String
  document    Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  authorId    String
  author      User           @relation("AnnotationAuthor", fields: [authorId], references: [id])
  type        AnnotationType
  pageNumber  Int
  coordinates Json
  content     String?
  color       String         @default("#FFFF00")
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([documentId])
  @@index([pageNumber])
  @@map("document_annotations")
}

model DocumentShare {
  id           String    @id @default(uuid())
  documentId   String
  document     Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sharedById   String
  sharedBy     User      @relation("ShareAuthor", fields: [sharedById], references: [id])
  sharedWithId String?
  sharedWith   User?     @relation("ShareRecipient", fields: [sharedWithId], references: [id])
  shareLink    String?   @unique
  expiresAt    DateTime?
  accessCount  Int       @default(0)
  canEdit      Boolean   @default(false)
  canDownload  Boolean   @default(true)
  createdAt    DateTime  @default(now())

  @@index([documentId])
  @@index([sharedById])
  @@index([sharedWithId])
  @@map("document_shares")
}

model DocumentPresence {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastSeenAt DateTime @default(now())

  @@unique([documentId, userId])
  @@index([documentId])
  @@index([lastSeenAt])
  @@map("document_presence")
}

enum DocumentConversionProvider {
  LOCAL
  CLOUDCONVERT
}

enum DocumentConversionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum DocumentFormDraftStatus {
  DRAFT
  FINALIZED
  CANCELLED
}

enum DocumentAuditPackageStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum DocumentFinalizeStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ImportStatus {
  PENDING
  VALIDATING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model DocumentConversionJob {
  id             String                     @id @default(uuid())
  documentId     String
  document       Document                   @relation(fields: [documentId], references: [id], onDelete: Cascade)
  provider       DocumentConversionProvider @default(LOCAL)
  status         DocumentConversionStatus   @default(PENDING)
  inputMimeType  String
  outputFileUrl  String?
  outputFileName String?
  outputFileSize Int?
  errorMessage   String?
  startedAt      DateTime?
  completedAt    DateTime?
  processingTime Int?
  attempts       Int                        @default(0)
  maxAttempts    Int                        @default(3)
  options        Json?
  createdById    String
  createdBy      User                       @relation("ConversionJobCreator", fields: [createdById], references: [id])
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt

  @@index([documentId])
  @@index([status])
  @@index([createdAt])
  @@map("document_conversion_jobs")
}

model DocumentFormTemplate {
  id              String   @id @default(uuid())
  documentId      String
  document        Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentVersion Int
  fieldSchema     Json
  fieldCount      Int      @default(0)
  createdById     String
  createdBy       User     @relation("FormTemplateCreator", fields: [createdById], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  drafts DocumentFormDraft[]

  @@unique([documentId, documentVersion])
  @@index([documentId])
  @@index([createdAt])
  @@map("document_form_templates")
}

model DocumentFormDraft {
  id                    String                  @id @default(uuid())
  documentId            String
  document              Document                @relation(fields: [documentId], references: [id], onDelete: Cascade)
  templateId            String?
  template              DocumentFormTemplate?   @relation(fields: [templateId], references: [id], onDelete: SetNull)
  status                DocumentFormDraftStatus @default(DRAFT)
  values                Json
  signatureData         String?
  signatureType         String?
  signatureReason       String?
  signatureMetadata     Json?
  outputFileUrl         String?
  outputFileName        String?
  outputFileSize        Int?
  outputDocumentVersion Int?
  finalizedAt           DateTime?
  cancelledAt           DateTime?
  createdById           String
  createdBy             User                    @relation("FormDraftCreator", fields: [createdById], references: [id])
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  @@index([documentId])
  @@index([templateId])
  @@index([status])
  @@index([createdAt])
  @@map("document_form_drafts")
}

model DocumentAuditPackageJob {
  id               String                     @id @default(uuid())
  status           DocumentAuditPackageStatus @default(PENDING)
  title            String
  spec             Json
  outputDocumentId String?
  outputDocument   Document?                  @relation("AuditPackageOutputDocument", fields: [outputDocumentId], references: [id], onDelete: SetNull)
  errorMessage     String?
  attempts         Int                        @default(0)
  maxAttempts      Int                        @default(3)
  startedAt        DateTime?
  completedAt      DateTime?
  createdById      String
  createdBy        User                       @relation("AuditPackageJobCreator", fields: [createdById], references: [id])
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("document_audit_package_jobs")
}

model DocumentFinalizeJob {
  id              String                 @id @default(uuid())
  documentId      String
  document        Document               @relation(fields: [documentId], references: [id], onDelete: Cascade)
  status          DocumentFinalizeStatus @default(PENDING)
  options         Json
  outputFileUrl   String?
  outputFileName  String?
  outputFileSize  Int?
  outputFileHash  String?
  integritySealId String?                @unique
  integritySeal   DocumentIntegritySeal? @relation("FinalizeJobIntegritySeal", fields: [integritySealId], references: [id], onDelete: SetNull)
  errorMessage    String?
  attempts        Int                    @default(0)
  maxAttempts     Int                    @default(3)
  startedAt       DateTime?
  completedAt     DateTime?
  createdById     String
  createdBy       User                   @relation("FinalizeJobCreator", fields: [createdById], references: [id])
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  @@index([documentId])
  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("document_finalize_jobs")
}

model DocumentIntegritySeal {
  id            String               @id @default(uuid())
  documentId    String
  document      Document             @relation(fields: [documentId], references: [id], onDelete: Cascade)
  versionNumber Int
  algorithm     String               @default("sha256")
  hash          String
  previousHash  String?
  metadata      Json?
  finalizeJob   DocumentFinalizeJob? @relation("FinalizeJobIntegritySeal")
  createdById   String
  createdBy     User                 @relation("IntegritySealCreator", fields: [createdById], references: [id])
  createdAt     DateTime             @default(now())

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@index([createdAt])
  @@map("document_integrity_seals")
}

model ImportJob {
  id              String          @id @default(uuid())
  module          String
  fileName        String
  fileUrl         String
  storageProvider String          @default("local")
  originalName    String
  totalRows       Int
  processedRows   Int             @default(0)
  successRows     Int             @default(0)
  errorRows       Int             @default(0)
  status          ImportStatus    @default(PENDING)
  errors          Json?
  warnings        Json?
  mappings        Json?
  context         Json?
  rollback        ImportRollback?
  scheduledAt     DateTime?
  batchId         String?
  createdById     String
  createdBy       User            @relation("ImportCreator", fields: [createdById], references: [id])
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime        @default(now())

  @@index([module])
  @@index([createdById])
  @@index([status])
  @@index([scheduledAt])
  @@index([batchId])
  @@map("import_jobs")
}

model ExportJob {
  id              String       @id @default(uuid())
  module          String
  fileName        String
  storageProvider String       @default("local")
  filters         Json?
  columns         String[]
  context         Json?
  totalRows       Int
  status          ExportStatus @default(PENDING)
  fileUrl         String?
  expiresAt       DateTime?
  createdById     String
  createdBy       User         @relation("ExportCreator", fields: [createdById], references: [id])
  completedAt     DateTime?
  createdAt       DateTime     @default(now())

  @@index([module])
  @@index([createdById])
  @@map("export_jobs")
}

model ImportTemplate {
  id          String   @id @default(uuid())
  name        String
  module      String
  description String?
  columns     Json
  isDefault   Boolean  @default(false)
  createdById String
  createdBy   User     @relation("ImportTemplateCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, module])
  @@map("import_templates")
}

model CsvAuditLog {
  id          String   @id @default(uuid())
  jobType     String
  jobId       String?
  action      String
  details     Json?
  createdById String?
  createdBy   User?    @relation("CsvAuditCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([jobType, jobId])
  @@index([createdAt])
  @@map("csv_audit_logs")
}

model ImportRollback {
  id           String    @id @default(uuid())
  importJobId  String    @unique
  importJob    ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)
  status       String    @default("AVAILABLE")
  rolledBackAt DateTime?
  createdAt    DateTime  @default(now())

  changes ImportChange[]

  @@index([importJobId])
  @@map("import_rollbacks")
}

model ImportChange {
  id         String         @id @default(uuid())
  rollbackId String
  rollback   ImportRollback @relation(fields: [rollbackId], references: [id], onDelete: Cascade)
  model      String
  recordId   String
  operation  String
  before     Json?
  after      Json?
  createdAt  DateTime       @default(now())

  @@index([rollbackId])
  @@index([model, recordId])
  @@map("import_changes")
}

model CsvBatch {
  id            String   @id @default(uuid())
  status        String   @default("PENDING")
  totalJobs     Int      @default(0)
  completedJobs Int      @default(0)
  failedJobs    Int      @default(0)
  createdById   String
  createdBy     User     @relation("CsvBatchCreator", fields: [createdById], references: [id])
  createdAt     DateTime @default(now())

  @@index([createdById])
  @@index([status])
  @@map("csv_batches")
}

model ScheduledExport {
  id          String    @id @default(uuid())
  name        String
  module      String
  filters     Json?
  columns     String[]
  context     Json?
  schedule    String
  recipients  String[]
  format      String    @default("csv")
  isActive    Boolean   @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  createdById String
  createdBy   User      @relation("ScheduledExportCreator", fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  runs ScheduledExportRun[]

  @@index([isActive, nextRunAt])
  @@index([module])
  @@map("scheduled_exports")
}

model ScheduledExportRun {
  id                String          @id @default(uuid())
  scheduledExportId String
  scheduledExport   ScheduledExport @relation(fields: [scheduledExportId], references: [id], onDelete: Cascade)
  exportJobId       String?
  status            String          @default("PENDING")
  errorMessage      String?
  sentAt            DateTime?
  createdAt         DateTime        @default(now())

  @@index([scheduledExportId])
  @@index([status])
  @@map("scheduled_export_runs")
}

// Phase 16.1: OCR & Text Extraction
enum OCRProvider {
  TESSERACT_JS
  GOOGLE_VISION
  AWS_TEXTRACT
}

enum OCRStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ExtractedDataType {
  INVOICE
  RECEIPT
  CONTRACT
  GENERAL_TEXT
  STRUCTURED_DATA
}

model OCRJob {
  id         String      @id @default(uuid())
  documentId String
  provider   OCRProvider @default(TESSERACT_JS)
  status     OCRStatus   @default(PENDING)
  priority   Int         @default(5) // 1-10, higher = more urgent

  // Processing details
  startedAt      DateTime?
  completedAt    DateTime?
  processingTime Int? // milliseconds

  // Results
  extractedText String? @db.Text
  confidence    Float? // 0-100
  pageCount     Int?
  errorMessage  String?

  // Configuration
  language     String  @default("eng")
  autoRotate   Boolean @default(true)
  enhanceImage Boolean @default(true)

  // Metadata
  createdById String
  createdBy   User     @relation("OCRJobCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  extractedData ExtractedDocumentData[]

  @@index([documentId])
  @@index([status])
  @@index([createdAt])
  @@map("ocr_jobs")
}

model ExtractedDocumentData {
  id         String            @id @default(uuid())
  ocrJobId   String
  ocrJob     OCRJob            @relation(fields: [ocrJobId], references: [id], onDelete: Cascade)
  documentId String
  dataType   ExtractedDataType

  // Extracted fields (JSON for flexibility)
  extractedFields Json // Structured data extracted from document
  confidence      Float? // Overall confidence score

  // Invoice-specific fields
  invoiceNumber   String?
  invoiceDate     DateTime?
  dueDate         DateTime?
  supplierName    String?
  supplierAddress String?
  totalAmount     Float?
  taxAmount       Float?
  currency        String?

  // Receipt-specific fields
  vendorName    String?
  receiptNumber String?
  receiptDate   DateTime?
  receiptAmount Float?
  paymentMethod String?

  // Contract-specific fields
  contractNumber String?
  contractDate   DateTime?
  partyNames     String[]
  contractValue  Float?
  startDate      DateTime?
  endDate        DateTime?

  // General extracted entities
  entities   Json? // Named entities (people, organizations, dates, amounts)
  keyPhrases String[]

  // Validation
  isValidated   Boolean   @default(false)
  validatedById String?
  validatedBy   User?     @relation("DataValidator", fields: [validatedById], references: [id])
  validatedAt   DateTime?

  // Corrections
  correctedFields Json? // User corrections to extracted data
  correctionNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ocrJobId])
  @@index([documentId])
  @@index([dataType])
  @@map("extracted_document_data")
}

model OCRConfiguration {
  id String @id @default(uuid())

  // Global settings
  defaultProvider   OCRProvider        @default(TESSERACT_JS)
  autoOCREnabled    Boolean            @default(false)
  autoOCRCategories DocumentCategory[]

  // Processing settings
  maxConcurrentJobs   Int    @default(3)
  defaultLanguage     String @default("eng")
  confidenceThreshold Float  @default(70.0)

  // Provider-specific settings
  tesseractConfig    Json? // Tesseract.js configuration
  googleVisionConfig Json? // Google Cloud Vision API config
  awsTextractConfig  Json? // AWS Textract config

  // Auto-processing rules
  autoCreateInvoice  Boolean @default(false)
  autoCreateExpense  Boolean @default(false)
  autoCreateContract Boolean @default(false)

  // Notifications
  notifyOnCompletion Boolean @default(true)
  notifyOnFailure    Boolean @default(true)

  // Retention
  retainRawText       Boolean @default(true)
  retainExtractedData Boolean @default(true)

  updatedById String
  updatedBy   User     @relation("OCRConfigUpdater", fields: [updatedById], references: [id])
  updatedAt   DateTime @updatedAt

  @@map("ocr_configuration")
}

model OCRProcessingLog {
  id        String   @id @default(uuid())
  ocrJobId  String
  level     String // INFO, WARNING, ERROR
  message   String   @db.Text
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([ocrJobId])
  @@index([timestamp])
  @@map("ocr_processing_logs")
}
